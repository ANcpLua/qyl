# qyl. Architecture Issues - AI Analysis Document
# Generated: 2024-12-11
# Purpose: Structured problem definition for architecture review
#
# Status: archived (pre-4-project migration)
# Current source of truth: /CLAUDE.md

problem_summary:
  title: "Triple Schema Chaos - Model/Schema/Extractor Duplication"
  severity: critical
  root_cause: "No single source of truth - TypeSpec generates models but they're duplicated manually everywhere"
  goal: "Single source of truth from TypeSpec → Generated models used everywhere"

# =============================================================================
# ISSUE 1: MISPLACED CODE - OtlpHttpHandler in qyl.grpc
# =============================================================================
misplaced_code:
  file: src/qyl.grpc/Protocol/OtlpHttpHandler.cs
  problem: "HTTP handler is in gRPC project - violates separation of concerns"
  evidence:
    - "Uses HttpContext from Microsoft.AspNetCore.Http"
    - "Handles application/json and application/x-protobuf"
    - "Should be in qyl.collector or separate protocol project"
  impact:
    - "gRPC project has ASP.NET HTTP dependencies"
    - "Confusing architecture for new developers"
    - "Cannot use gRPC project without ASP.NET reference"

# =============================================================================
# ISSUE 2: TRIPLE SCHEMA DUPLICATION
# =============================================================================
schema_duplication:
  description: "Same span/session schema defined in 3+ different places"

  locations:
    duckdb_schema_v1:
      file: src/qyl.collector/Storage/DuckDbStore.cs
      lines: 35-100
      schema_version: "1.0"
      columns:
        - trace_id: VARCHAR
        - span_id: VARCHAR
        - session_id: VARCHAR
        - name: VARCHAR
        - kind: VARCHAR  # STRING not UTINYINT!
        - start_time: TIMESTAMPTZ
        - end_time: TIMESTAMPTZ
        - duration_ms: DOUBLE (computed)
        - status_code: INT
        - provider_name: VARCHAR
        - request_model: VARCHAR
        - tokens_in: INT  # NOT BIGINT!
        - tokens_out: INT
        - attributes: JSON  # NOT MAP!

    duckdb_schema_v2:
      file: src/qyl.collector/Storage/DuckDbSchema.cs
      lines: 35-103
      schema_version: "2.0.0"
      columns:
        - trace_id: VARCHAR(32)
        - span_id: VARCHAR(16)
        - start_time_unix_nano: BIGINT  # DIFFERENT NAME!
        - end_time_unix_nano: BIGINT
        - duration_ns: BIGINT (computed)
        - kind: UTINYINT  # DIFFERENT TYPE!
        - status_code: UTINYINT
        - "gen_ai.usage.input_tokens": BIGINT  # DIFFERENT NAME!
        - "gen_ai.usage.output_tokens": BIGINT
        - attributes: "MAP(VARCHAR, VARCHAR)"  # DIFFERENT TYPE!

    grpc_model:
      file: src/qyl.grpc/Models/SpanModel.cs
      type: "C# record"
      properties:
        - TraceId: string
        - SpanId: string
        - Name: string
        - Kind: SpanKind (enum 0-5)
        - StartTime: DateTimeOffset
        - EndTime: DateTimeOffset
        - Status: SpanStatus (enum)
        - Attributes: "IReadOnlyDictionary<string, AttributeValue>"
        - Events: "IReadOnlyList<SpanEvent>"
        - Links: "IReadOnlyList<SpanLink>"
        - Resource: ResourceModel

    collector_parsed_span:
      file: src/qyl.collector/Models/ParsedSpan.cs
      type: "C# class"
      properties:
        - TraceId: TraceId (custom struct)
        - SpanId: SpanId (custom struct)
        - Name: string
        - Kind: SpanKind (LOCAL enum - DUPLICATE!)
        - StartTime: UnixNano (custom struct)
        - EndTime: UnixNano (custom struct)
        - Status: StatusCode (LOCAL enum - DUPLICATE!)
        - ProviderName: "string?"
        - RequestModel: "string?"
        - InputTokens: long
        - OutputTokens: long
        - Attributes: "List<KeyValuePair<string, object?>>?"

    duckdb_store_span_record:
      file: src/qyl.collector/Storage/DuckDbStore.cs
      lines: 532-553
      type: "C# record SpanRecord"
      properties:
        - TraceId: string
        - SpanId: string
        - SessionId: "string?"
        - Name: string
        - Kind: "string?"  # STRING not enum!
        - StartTime: DateTime
        - EndTime: DateTime
        - StatusCode: "int?"
        - ProviderName: "string?"
        - RequestModel: "string?"
        - TokensIn: "int?"  # int not long!
        - TokensOut: "int?"
        - Attributes: "string?"  # JSON string!

  conflicts:
    type_mismatches:
      - field: kind
        types: ["VARCHAR", "UTINYINT", "SpanKind enum", "string?"]
        locations: [DuckDbStore, DuckDbSchema, SpanModel, SpanRecord]

      - field: tokens
        types: ["INT", "BIGINT", "long", "int?"]
        locations: [DuckDbStore, DuckDbSchema, ParsedSpan, SpanRecord]

      - field: attributes
        types: ["JSON", "MAP(VARCHAR,VARCHAR)", "IReadOnlyDictionary", "List<KVP>", "string?"]
        locations: [DuckDbStore, DuckDbSchema, SpanModel, ParsedSpan, SpanRecord]

      - field: time
        types: ["TIMESTAMPTZ", "BIGINT (unix_nano)", "DateTimeOffset", "UnixNano struct", "DateTime"]
        locations: [DuckDbStore, DuckDbSchema, SpanModel, ParsedSpan, SpanRecord]

    naming_conflicts:
      - concept: "input tokens"
        names: ["tokens_in", "gen_ai.usage.input_tokens", "InputTokens", "TokensIn"]

      - concept: "span status"
        names: ["status_code", "Status", "StatusCode"]
        enums: ["SpanStatus (grpc)", "StatusCode (collector)"]

# =============================================================================
# ISSUE 3: DUPLICATE SESSION AGGREGATION LOGIC
# =============================================================================
session_aggregation_duplication:
  description: "Two session aggregators with different implementations"

  implementations:
    in_memory:
      file: src/qyl.collector/Query/SessionAggregator.cs
      approach: "ConcurrentDictionary<string, SessionStats> in memory"
      features:
        - "Real-time tracking via TrackSpan()"
        - "Memory-based aggregation"
        - "Manual HashSet for services/models dedup"
      problems:
        - "Data lost on restart"
        - "Memory grows unbounded"
        - "Inconsistent with DuckDB state"

    sql_based:
      file: src/qyl.collector/Query/SessionQueryService.cs
      approach: "Pure DuckDB SQL aggregation"
      features:
        - "All state in DuckDB"
        - "SQL GROUP BY for aggregation"
        - "LIST(DISTINCT ...) for dedup"
      problems:
        - "Comment says 'Replaces SessionAggregator.cs entirely'"
        - "But both files exist!"
        - "Which one is actually used?"

  dto_duplication:
    session_summary_v1:
      file: src/qyl.collector/Query/SessionAggregator.cs
      lines: 161-177
      has_services: true  # IReadOnlyList<string> Services

    session_summary_v2:
      file: src/qyl.collector/Query/SessionQueryService.cs
      lines: 366-382
      has_services: false  # NO Services property!

    conflict: "Two SessionSummary records in same namespace with different shapes"

# =============================================================================
# ISSUE 4: EXTRACTOR DUPLICATION
# =============================================================================
extractor_duplication:
  description: "GenAI attribute extraction logic duplicated"

  locations:
    collector_ingestion:
      file: src/qyl.collector/Ingestion/GenAiExtractor.cs
      namespace: qyl.collector.Ingestion

    grpc_extraction:
      file: src/qyl.grpc/Extraction/GenAiExtractor.cs
      namespace: qyl.grpc.Extraction

  impact:
    - "Which attributes are extracted depends on which extractor runs"
    - "Bug fixes must be applied twice"
    - "OTel 1.38 deprecated attribute handling may differ"

# =============================================================================
# ISSUE 5: MISSING .NET 10 PATTERNS
# =============================================================================
performance_issues:
  description: "Old patterns used instead of .NET 10 optimized APIs"

  violations:
    wrong_lock_pattern:
      file: src/qyl.collector/Storage/DuckDbStore.cs
      line: 105
      found: "SemaphoreSlim _writeLock = new(1, 1)"
      required: "Lock _lock = new(); using (_lock.EnterScope())"
      severity: medium

    missing_countby:
      file: src/qyl.collector/Query/SessionAggregator.cs
      description: "Manual GroupBy + Count where CountBy would be cleaner"

    missing_whenreach:
      file: src/qyl.collector/Storage/DuckDbStore.cs
      line: 157
      found: "await foreach (var batch in _writeChannel.Reader.ReadAllAsync"
      note: "This is correct, but if processing Task list, use Task.WhenEach"

# =============================================================================
# ISSUE 6: TYPESPEC NOT USED AS SOURCE OF TRUTH
# =============================================================================
typespec_disconnect:
  description: "TypeSpec generates models but they're not used"

  typespec_location: core/specs/
  generated_location: core/generated/dotnet/

  problem:
    - "TypeSpec defines OTel span schema"
    - "Kiota generates QylClient with models"
    - "But collector uses hand-written ParsedSpan, SpanRecord, SpanModel"
    - "Generated models are unused"

  should_be:
    - "TypeSpec → OpenAPI → Single C# model"
    - "All projects reference generated model"
    - "No hand-written span/session models"

# =============================================================================
# RECOMMENDED SOLUTION
# =============================================================================
solution:
  title: "Single Source of Truth from TypeSpec"

  phase_1_unify_models:
    description: "Use generated models from TypeSpec"
    actions:
      - "Delete src/qyl.collector/Models/ParsedSpan.cs"
      - "Delete src/qyl.grpc/Models/SpanModel.cs (use generated)"
      - "Update imports to use core/generated/dotnet/Models"

  phase_2_unify_schema:
    description: "Single DuckDB schema derived from TypeSpec"
    actions:
      - "Delete old schema in DuckDbStore.cs"
      - "Keep DuckDbSchema.cs as authoritative"
      - "Generate schema DDL from TypeSpec if possible"

  phase_3_unify_extractors:
    description: "Single GenAiExtractor in qyl.agents.telemetry"
    actions:
      - "Move extraction to qyl.agents.telemetry"
      - "Delete duplicate extractors"
      - "All projects reference single extractor"

  phase_4_remove_in_memory_aggregator:
    description: "Use SessionQueryService only"
    actions:
      - "Delete SessionAggregator.cs"
      - "Update all callers to use SessionQueryService"
      - "Remove duplicate SessionSummary record"

  phase_5_move_http_handler:
    description: "Move OtlpHttpHandler out of gRPC project"
    actions:
      - "Create qyl.protocol or move to qyl.collector"
      - "Remove ASP.NET dependency from qyl.grpc"

# =============================================================================
# DEPENDENCY GRAPH (CURRENT VS TARGET)
# =============================================================================
dependency_graph:
  current:
    qyl.collector:
      - qyl.grpc  # pulls in HTTP handler incorrectly
    qyl.grpc:
      - qyl.agents.telemetry
      - Microsoft.AspNetCore.App  # WRONG - gRPC shouldn't need this for HTTP
    qyl.demo:
      - qyl.sdk.aspnetcore
      - qyl.agents.telemetry

  target:
    qyl.collector:
      - qyl.grpc
      - core.generated.dotnet  # Use generated models
    qyl.grpc:
      - qyl.agents.telemetry
      - core.generated.dotnet  # Use generated models
      # NO Microsoft.AspNetCore.App - pure gRPC
    qyl.protocol:  # NEW - HTTP protocol handling
      - qyl.grpc
      - Microsoft.AspNetCore.App

# =============================================================================
# FILES TO REVIEW (PRIORITY ORDER)
# =============================================================================
review_priority:
  critical:
    - src/qyl.collector/Storage/DuckDbSchema.cs
    - src/qyl.collector/Storage/DuckDbStore.cs
    - src/qyl.collector/Query/SessionQueryService.cs
    - src/qyl.grpc/Protocol/OtlpHttpHandler.cs

  high:
    - src/qyl.collector/Query/SessionAggregator.cs
    - src/qyl.collector/Models/ParsedSpan.cs
    - src/qyl.grpc/Models/SpanModel.cs
    - src/qyl.collector/Ingestion/GenAiExtractor.cs
    - src/qyl.grpc/Extraction/GenAiExtractor.cs

  medium:
    - core/specs/otel/span.tsp
    - core/generated/dotnet/Models/
