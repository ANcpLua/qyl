#!/bin/bash
# ═══════════════════════════════════════════════════════════════════════════════
# autogen-guard.sh - Claude Code Hook (PreToolUse: Write, Edit)
# ═══════════════════════════════════════════════════════════════════════════════
# Prevents manual edits to auto-generated files.
# When a generated file is detected, blocks the edit and shows the source.
#
# Install: Copy to .claude/hooks/autogen-guard.sh
# Configure in .claude/settings.json:
#   "hooks": {
#     "PreToolUse": [
#       { "matcher": "Write|Edit", "command": ".claude/hooks/autogen-guard.sh" }
#     ]
#   }
# ═══════════════════════════════════════════════════════════════════════════════

set -euo pipefail

# File path passed as first argument
FILE="${1:-}"

if [[ -z "$FILE" ]]; then
    exit 0
fi

# ═══════════════════════════════════════════════════════════════════════════════
# 1. Check if file exists and has auto-generated marker
# ═══════════════════════════════════════════════════════════════════════════════

is_generated() {
    local file="$1"
    [[ -f "$file" ]] && head -20 "$file" 2>/dev/null | grep -qE '<auto-generated>|AUTO-GENERATED|Generated by|Do not edit'
}

# ═══════════════════════════════════════════════════════════════════════════════
# 2. Check if path is in a known generated directory
# ═══════════════════════════════════════════════════════════════════════════════

is_generated_path() {
    local file="$1"
    case "$file" in
        */core/generated/*) return 0 ;;          # Kiota output
        */Generated/*)      return 0 ;;          # .NET conventions
        */.generated/*)     return 0 ;;          # Hidden generated
        *.g.cs)             return 0 ;;          # Generated C#
        *.generated.ts)     return 0 ;;          # Generated TS
        *)                  return 1 ;;
    esac
}

# ═══════════════════════════════════════════════════════════════════════════════
# 3. Allow NUKE to write generated files
# ═══════════════════════════════════════════════════════════════════════════════

if [[ "${NUKE_BUILD_RUNNING:-}" == "true" ]]; then
    exit 0
fi

# ═══════════════════════════════════════════════════════════════════════════════
# 4. Main guard logic
# ═══════════════════════════════════════════════════════════════════════════════

# Check existing file for auto-generated header
if is_generated "$FILE"; then
    echo "═══════════════════════════════════════════════════════════════════════════════"
    echo "  ❌ BLOCKED: $FILE is auto-generated"
    echo "═══════════════════════════════════════════════════════════════════════════════"
    echo ""
    echo "  This file was generated by qyl.build. DO NOT edit manually."
    echo ""
    
    # Extract source info from header if available
    SOURCE=$(head -20 "$FILE" 2>/dev/null | grep -oP '(?<=Source:\s{4}).*' || echo "unknown")
    GENERATOR=$(head -20 "$FILE" 2>/dev/null | grep -oP '(?<=Generator:\s).*' || echo "unknown")
    
    echo "  Source:    $SOURCE"
    echo "  Generator: $GENERATOR"
    echo ""
    echo "  To change this code:"
    
    # Provide specific guidance based on generator
    case "$FILE" in
        */core/generated/*)
            echo "    1. Edit: core/specs/*.tsp (TypeSpec)"
            echo "    2. Run:  nuke TypeSpecCompile"
            echo "    3. Run:  nuke GenerateAll"
            ;;
        *.g.cs)
            echo "    1. Edit: eng/build/Domain/CodeGen/QylSchema.cs"
            echo "    2. Run:  nuke Generate"
            ;;
        */models.ts|*/api-types.ts|*/index.ts)
            echo "    1. Edit: eng/build/Domain/CodeGen/QylSchema.cs"
            echo "    2. Edit: eng/build/Domain/CodeGen/Generators/TypeScriptGenerator.cs"
            echo "    3. Run:  nuke Generate"
            ;;
        *)
            echo "    1. Find the source schema or spec file"
            echo "    2. Edit the source, not the generated output"
            echo "    3. Regenerate with: nuke Generate"
            ;;
    esac
    
    echo ""
    echo "═══════════════════════════════════════════════════════════════════════════════"
    exit 1
fi

# Check if writing to a known generated directory (even if file doesn't exist yet)
if is_generated_path "$FILE"; then
    echo "═══════════════════════════════════════════════════════════════════════════════"
    echo "  ⚠️  WARNING: Writing to generated directory"
    echo "═══════════════════════════════════════════════════════════════════════════════"
    echo ""
    echo "  Path: $FILE"
    echo ""
    echo "  This directory contains auto-generated files."
    echo "  Manual files here will be OVERWRITTEN by the next generation."
    echo ""
    echo "  Consider:"
    echo "    - Adding to the generator if this should be generated"
    echo "    - Moving to a non-generated directory if manual"
    echo ""
    echo "═══════════════════════════════════════════════════════════════════════════════"
    # Allow but warn (could change to exit 1 to block)
    exit 0
fi

exit 0
