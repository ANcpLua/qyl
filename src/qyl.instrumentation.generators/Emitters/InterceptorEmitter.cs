// =============================================================================
// qyl.instrumentation.generators - Interceptor Code Emitter
// Generates C# interceptor code that wraps GenAI calls with OTel spans
// Owner: qyl.instrumentation.generators
// =============================================================================

using qyl.instrumentation.generators.Extractors;
using qyl.instrumentation.generators.Interceptors;

namespace qyl.instrumentation.generators.Emitters;

/// <summary>
///     Emits C# interceptor code that wraps method calls with OTel spans.
///     Uses qyl.protocol GenAiAttributes for semantic conventions.
/// </summary>
internal static class InterceptorEmitter
{
    public static string Emit(IEnumerable<InterceptorTarget> targets)
    {
        var sb = new StringBuilder();

        sb.AppendLine("""
                      // <auto-generated/>
                      // Generated by qyl.instrumentation.generators
                      //
                      // Interception = HOW you capture data (this code)
                      // Semantic conventions = WHAT you capture (qyl.protocol.GenAiAttributes)
                      //
                      // LIMITATIONS:
                      // - Cannot intercept interface calls
                      // - Cannot intercept virtual dispatch
                      // - Cannot intercept compiled packages
                      // - Only works on YOUR source code

                      #nullable enable

                      using System;
                      using System.Diagnostics;
                      using System.Runtime.CompilerServices;
                      using System.Threading.Tasks;
                      using qyl.protocol.Attributes;

                      namespace qyl.instrumentation.Generated;

                      /// <summary>
                      /// Auto-generated interceptors for GenAI SDK calls.
                      /// </summary>
                      [System.CodeDom.Compiler.GeneratedCode("qyl.instrumentation.generators", "1.0.0")]
                      file static class GenAiInterceptors
                      {
                          private static readonly ActivitySource Source = new(
                              "qyl.instrumentation.GenAi",
                              "1.0.0");

                      """);

        foreach (var target in targets)
        {
            EmitInterceptor(sb, target);
        }

        // Add the response extractor helper
        sb.AppendLine(ResponseExtractorSource.Source);

        sb.AppendLine("}");

        return sb.ToString();
    }

    private static void EmitInterceptor(StringBuilder sb, InterceptorTarget target)
    {
        var methodId = GetMethodId(target);
        var isTask = target.ReturnType.Contains("Task");
        var isVoid = target.ReturnType is "void" or "System.Void";

        sb.AppendLine($"""
                           /// <summary>Intercepts {target.ContainingType}.{target.MethodName}</summary>
                           [InterceptsLocation(@"{EscapePath(target.FilePath)}", {target.Line}, {target.Column})]
                       """);

        switch (isTask)
        {
            case true when !isVoid:
                EmitAsyncInterceptor(sb, target, methodId);
                break;
            case true:
                EmitAsyncVoidInterceptor(sb, target, methodId);
                break;
            default:
                EmitSyncInterceptor(sb, target, methodId);
                break;
        }
    }

    private static void EmitAsyncInterceptor(StringBuilder sb, InterceptorTarget target, string methodId) =>
        sb.AppendLine($$"""
                            internal static async {{target.ReturnType}} {{methodId}}(
                                this {{target.ContainingType}} instance{{FormatParameters(target.Parameters)}})
                            {
                                using var activity = Source.StartActivity("{{target.SpanNameTemplate}}", ActivityKind.Client);

                                // OTel GenAI semantic conventions (gen_ai.*)
                                activity?.SetTag(GenAiAttributes.ProviderName, "{{target.Provider}}");
                                activity?.SetTag(GenAiAttributes.OperationName, "{{target.Operation}}");

                                try
                                {
                                    var result = await instance.{{target.MethodName}}({{FormatArguments(target.Parameters)}}).ConfigureAwait(false);

                                    // Extract response attributes if available
                                    ExtractResponseAttributes(activity, result);

                                    activity?.SetStatus(ActivityStatusCode.Ok);
                                    return result;
                                }
                                catch (Exception ex)
                                {
                                    activity?.SetStatus(ActivityStatusCode.Error, ex.Message);
                                    activity?.RecordException(ex);
                                    throw;
                                }
                            }

                        """);

    private static void EmitAsyncVoidInterceptor(StringBuilder sb, InterceptorTarget target, string methodId) =>
        sb.AppendLine($$"""
                            internal static async Task {{methodId}}(
                                this {{target.ContainingType}} instance{{FormatParameters(target.Parameters)}})
                            {
                                using var activity = Source.StartActivity("{{target.SpanNameTemplate}}", ActivityKind.Client);

                                activity?.SetTag(GenAiAttributes.ProviderName, "{{target.Provider}}");
                                activity?.SetTag(GenAiAttributes.OperationName, "{{target.Operation}}");

                                try
                                {
                                    await instance.{{target.MethodName}}({{FormatArguments(target.Parameters)}}).ConfigureAwait(false);
                                    activity?.SetStatus(ActivityStatusCode.Ok);
                                }
                                catch (Exception ex)
                                {
                                    activity?.SetStatus(ActivityStatusCode.Error, ex.Message);
                                    activity?.RecordException(ex);
                                    throw;
                                }
                            }

                        """);

    private static void EmitSyncInterceptor(StringBuilder sb, InterceptorTarget target, string methodId)
    {
        var isVoid = target.ReturnType is "void" or "System.Void";

        sb.AppendLine($$"""
                            internal static {{target.ReturnType}} {{methodId}}(
                                this {{target.ContainingType}} instance{{FormatParameters(target.Parameters)}})
                            {
                                using var activity = Source.StartActivity("{{target.SpanNameTemplate}}", ActivityKind.Client);

                                activity?.SetTag(GenAiAttributes.ProviderName, "{{target.Provider}}");
                                activity?.SetTag(GenAiAttributes.OperationName, "{{target.Operation}}");

                                try
                                {
                        """);

        sb.AppendLine(isVoid
            ? $"""
                           instance.{target.MethodName}({FormatArguments(target.Parameters)});
                           activity?.SetStatus(ActivityStatusCode.Ok);
               """
            : $"""
                           var result = instance.{target.MethodName}({FormatArguments(target.Parameters)});
                           ExtractResponseAttributes(activity, result);
                           activity?.SetStatus(ActivityStatusCode.Ok);
                           return result;
               """);

        sb.AppendLine("""
                              }
                              catch (Exception ex)
                              {
                                  activity?.SetStatus(ActivityStatusCode.Error, ex.Message);
                                  activity?.RecordException(ex);
                                  throw;
                              }
                          }

                      """);
    }

    private static string GetMethodId(InterceptorTarget target)
        => $"Intercept_{SanitizeIdentifier(target.ContainingType)}_{target.MethodName}_{target.Line}_{target.Column}";

    private static string SanitizeIdentifier(string name)
        => name.Replace(".", "_").Replace("<", "_").Replace(">", "_").Replace(",", "_").Replace(" ", "");

    private static string EscapePath(string path)
        => path.Replace("\\", @"\\");

    private static string FormatParameters(IReadOnlyCollection<ParameterInfo> parameters)
    {
        if (parameters.Count is 0) return "";
        return ", " + string.Join(", ", parameters.Select(static p => $"{p.Type} @{p.Name}"));
    }

    private static string FormatArguments(IEnumerable<ParameterInfo> parameters)
        => string.Join(", ", parameters.Select(static p => $"@{p.Name}"));
}
