using System.Collections.Immutable;
using System.Text;
using Qyl.ServiceDefaults.Generator.Models;

namespace Qyl.ServiceDefaults.Generator.Emitters;

/// <summary>
///     Emits Activity.SetTag() extension methods for types with [OTel] attributes.
/// </summary>
internal static class OTelTagsEmitter
{
    /// <summary>
    ///     Emits the extension methods source code for all OTel-tagged members.
    /// </summary>
    public static string Emit(ImmutableArray<OTelTagInfo> tags)
    {
        if (tags.IsEmpty)
            return string.Empty;

        var sb = new StringBuilder();

        AppendFileHeader(sb);
        AppendUsings(sb);
        AppendClassOpen(sb);
        AppendExtensionMethods(sb, tags);
        AppendClassClose(sb);

        return sb.ToString();
    }

    private static void AppendFileHeader(StringBuilder sb)
    {
        sb.AppendLine("// <auto-generated/>");
        sb.AppendLine("#nullable enable");
        sb.AppendLine();
    }

    private static void AppendUsings(StringBuilder sb)
    {
        sb.AppendLine("using System.Diagnostics;");
        sb.AppendLine();
    }

    private static void AppendClassOpen(StringBuilder sb)
    {
        sb.AppendLine("""
                      namespace Qyl.ServiceDefaults.Generator
                      {
                          /// <summary>
                          /// Generated extension methods for setting OTel tags on Activity.
                          /// </summary>
                          internal static class OTelTagExtensions
                          {
                      """);
    }

    private static void AppendExtensionMethods(
        StringBuilder sb,
        ImmutableArray<OTelTagInfo> tags)
    {
        var byType = tags
            .GroupBy(static t => t.ContainingTypeName)
            .OrderBy(static g => g.Key, StringComparer.Ordinal);

        foreach (var group in byType)
        {
            var typeName = group.Key;
            var typeMembers = group.OrderBy(static t => t.MemberName, StringComparer.Ordinal);

            AppendTypeExtension(sb, typeName, typeMembers);
        }
    }

    private static void AppendTypeExtension(
        StringBuilder sb,
        string typeName,
        IEnumerable<OTelTagInfo> members)
    {
        var methodName = GenerateMethodName(typeName);

        sb.AppendLine($$"""
                                /// <summary>
                                /// Sets OTel tags on the activity from a <see cref="{{typeName}}"/> instance.
                                /// </summary>
                                public static Activity? SetTagsFrom{{methodName}}(this Activity? activity, {{typeName}} value)
                                {
                                    if (activity is null || value is null)
                                        return activity;

                        """);

        foreach (var member in members)
            AppendTagSetter(sb, member);

        sb.AppendLine("""
                                  return activity;
                              }

                      """);
    }

    private static void AppendTagSetter(StringBuilder sb, OTelTagInfo tag)
    {
        var accessor = $"value.{tag.MemberName}";
        var attributeName = tag.AttributeName;

        if (tag.SkipIfNull && (tag.IsNullable || !IsValueType(tag.MemberTypeName)))
            sb.AppendLine($"""
                                            if ({accessor} is not null)
                                                activity.SetTag("{attributeName}", {accessor});
                            """);
        else
            sb.AppendLine($"""
                                            activity.SetTag("{attributeName}", {accessor});
                            """);
    }

    private static string GenerateMethodName(string typeName)
    {
        var name = typeName
            .Replace("global::", "")
            .Replace(".", "_")
            .Replace("<", "_")
            .Replace(">", "_")
            .Replace(",", "_")
            .Replace(" ", "");

        return name;
    }

    private static bool IsValueType(string typeName) =>
        typeName.StartsWith("global::System.Int", StringComparison.Ordinal) ||
        typeName.StartsWith("global::System.UInt", StringComparison.Ordinal) ||
        typeName.StartsWith("global::System.Double", StringComparison.Ordinal) ||
        typeName.StartsWith("global::System.Single", StringComparison.Ordinal) ||
        typeName.StartsWith("global::System.Decimal", StringComparison.Ordinal) ||
        typeName.StartsWith("global::System.Boolean", StringComparison.Ordinal) ||
        typeName.StartsWith("global::System.Byte", StringComparison.Ordinal) ||
        typeName.StartsWith("global::System.SByte", StringComparison.Ordinal) ||
        typeName.StartsWith("global::System.Char", StringComparison.Ordinal) ||
        typeName.StartsWith("global::System.DateTime", StringComparison.Ordinal) ||
        typeName.StartsWith("global::System.TimeSpan", StringComparison.Ordinal) ||
        typeName.StartsWith("global::System.Guid", StringComparison.Ordinal) ||
        typeName == "int" ||
        typeName == "uint" ||
        typeName == "long" ||
        typeName == "ulong" ||
        typeName == "short" ||
        typeName == "ushort" ||
        typeName == "byte" ||
        typeName == "sbyte" ||
        typeName == "float" ||
        typeName == "double" ||
        typeName == "decimal" ||
        typeName == "bool" ||
        typeName == "char";

    private static void AppendClassClose(StringBuilder sb)
    {
        sb.AppendLine("""
                          }
                      }
                      """);
    }
}
