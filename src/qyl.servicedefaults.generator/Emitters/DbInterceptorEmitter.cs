using System.Collections.Immutable;
using System.Text;
using Qyl.ServiceDefaults.Generator.Models;
using Microsoft.CodeAnalysis.CSharp;

namespace Qyl.ServiceDefaults.Generator.Emitters;

/// <summary>
///     Emits interceptor source code for ADO.NET DbCommand method invocations.
/// </summary>
internal static class DbInterceptorEmitter
{
    /// <summary>
    ///     Emits the interceptor source code for all DbCommand invocations.
    /// </summary>
    public static string Emit(ImmutableArray<DbInvocationInfo> invocations)
    {
        if (invocations.IsEmpty)
            return string.Empty;

        var sb = new StringBuilder();

        AppendFileHeader(sb);
        AppendUsings(sb);
        AppendInterceptsLocationAttribute(sb);
        AppendClassOpen(sb);
        AppendInterceptorMethods(sb, invocations);
        AppendClassClose(sb);

        return sb.ToString();
    }

    private static void AppendFileHeader(StringBuilder sb)
    {
        sb.AppendLine("// <auto-generated/>");
        sb.AppendLine("#pragma warning disable");
        sb.AppendLine();
    }

    private static void AppendInterceptsLocationAttribute(StringBuilder sb)
    {
        sb.AppendLine("""
                      namespace System.Runtime.CompilerServices
                      {
                          [global::System.AttributeUsage(global::System.AttributeTargets.Method, AllowMultiple = true)]
                          file sealed class InterceptsLocationAttribute(int version, string data) : global::System.Attribute;
                      }
                      """);
        sb.AppendLine();
    }

    private static void AppendUsings(StringBuilder sb)
    {
        sb.AppendLine("using System.Data.Common;");
        sb.AppendLine("using System.Threading;");
        sb.AppendLine("using System.Threading.Tasks;");
        sb.AppendLine("using Qyl.ServiceDefaults.Instrumentation.Db;");
        sb.AppendLine();
    }

    private static void AppendClassOpen(StringBuilder sb)
    {
        sb.AppendLine("""
                      namespace Qyl.ServiceDefaults.Generator
                      {
                          file static class DbInterceptors
                          {
                      """);
    }

    private static void AppendInterceptorMethods(
        StringBuilder sb,
        ImmutableArray<DbInvocationInfo> invocations)
    {
        var orderedInvocations = invocations
            .OrderBy(static i => i.OrderKey, StringComparer.Ordinal);

        var index = 0;
        foreach (var invocation in orderedInvocations)
        {
            AppendSingleInterceptor(sb, invocation, index);
            index++;
        }
    }

    private static void AppendSingleInterceptor(
        StringBuilder sb,
        DbInvocationInfo invocation,
        int index)
    {
        var displayLocation = invocation.InterceptableLocation.GetDisplayLocation();
        var interceptAttribute = invocation.InterceptableLocation.GetInterceptsLocationAttributeSyntax();

        var methodName = $"Intercept_Db_{index}";

        var commandType = invocation.ConcreteCommandType is not null
            ? $"global::{invocation.ConcreteCommandType}"
            : "global::System.Data.Common.DbCommand";

        switch (invocation.Method)
        {
            case DbCommandMethod.ExecuteReader when invocation.IsAsync:
                EmitExecuteReaderAsync(sb, displayLocation, interceptAttribute, methodName, commandType);
                break;

            case DbCommandMethod.ExecuteReader:
                EmitExecuteReader(sb, displayLocation, interceptAttribute, methodName, commandType);
                break;

            case DbCommandMethod.ExecuteNonQuery when invocation.IsAsync:
                EmitExecuteNonQueryAsync(sb, displayLocation, interceptAttribute, methodName, commandType);
                break;

            case DbCommandMethod.ExecuteNonQuery:
                EmitExecuteNonQuery(sb, displayLocation, interceptAttribute, methodName, commandType);
                break;

            case DbCommandMethod.ExecuteScalar when invocation.IsAsync:
                EmitExecuteScalarAsync(sb, displayLocation, interceptAttribute, methodName, commandType);
                break;

            case DbCommandMethod.ExecuteScalar:
                EmitExecuteScalar(sb, displayLocation, interceptAttribute, methodName, commandType);
                break;
        }
    }

    private static void EmitExecuteReaderAsync(
        StringBuilder sb,
        string displayLocation,
        string interceptAttribute,
        string methodName,
        string commandType)
    {
        sb.AppendLine($$"""
                                // Intercepted call at {{displayLocation}}
                                {{interceptAttribute}}
                                public static global::System.Threading.Tasks.Task<global::System.Data.Common.DbDataReader> {{methodName}}(
                                    this {{commandType}} command,
                                    global::System.Threading.CancellationToken cancellationToken = default)
                                {
                                    return DbInstrumentation.ExecuteReaderAsync(command, cancellationToken);
                                }

                        """);
    }

    private static void EmitExecuteReader(
        StringBuilder sb,
        string displayLocation,
        string interceptAttribute,
        string methodName,
        string commandType)
    {
        sb.AppendLine($$"""
                                // Intercepted call at {{displayLocation}}
                                {{interceptAttribute}}
                                public static global::System.Data.Common.DbDataReader {{methodName}}(
                                    this {{commandType}} command)
                                {
                                    return DbInstrumentation.ExecuteReader(command);
                                }

                        """);
    }

    private static void EmitExecuteNonQueryAsync(
        StringBuilder sb,
        string displayLocation,
        string interceptAttribute,
        string methodName,
        string commandType)
    {
        sb.AppendLine($$"""
                                // Intercepted call at {{displayLocation}}
                                {{interceptAttribute}}
                                public static global::System.Threading.Tasks.Task<int> {{methodName}}(
                                    this {{commandType}} command,
                                    global::System.Threading.CancellationToken cancellationToken = default)
                                {
                                    return DbInstrumentation.ExecuteNonQueryAsync(command, cancellationToken);
                                }

                        """);
    }

    private static void EmitExecuteNonQuery(
        StringBuilder sb,
        string displayLocation,
        string interceptAttribute,
        string methodName,
        string commandType)
    {
        sb.AppendLine($$"""
                                // Intercepted call at {{displayLocation}}
                                {{interceptAttribute}}
                                public static int {{methodName}}(
                                    this {{commandType}} command)
                                {
                                    return DbInstrumentation.ExecuteNonQuery(command);
                                }

                        """);
    }

    private static void EmitExecuteScalarAsync(
        StringBuilder sb,
        string displayLocation,
        string interceptAttribute,
        string methodName,
        string commandType)
    {
        sb.AppendLine($$"""
                                // Intercepted call at {{displayLocation}}
                                {{interceptAttribute}}
                                public static global::System.Threading.Tasks.Task<object?> {{methodName}}(
                                    this {{commandType}} command,
                                    global::System.Threading.CancellationToken cancellationToken = default)
                                {
                                    return DbInstrumentation.ExecuteScalarAsync(command, cancellationToken);
                                }

                        """);
    }

    private static void EmitExecuteScalar(
        StringBuilder sb,
        string displayLocation,
        string interceptAttribute,
        string methodName,
        string commandType)
    {
        sb.AppendLine($$"""
                                // Intercepted call at {{displayLocation}}
                                {{interceptAttribute}}
                                public static object? {{methodName}}(
                                    this {{commandType}} command)
                                {
                                    return DbInstrumentation.ExecuteScalar(command);
                                }

                        """);
    }

    private static void AppendClassClose(StringBuilder sb)
    {
        sb.AppendLine("""
                          }
                      }
                      """);
    }
}
