<Project Sdk="ANcpLua.NET.Sdk">
  <PropertyGroup>
    <TargetFrameworks>net10.0;netstandard2.0</TargetFrameworks>

    <!-- Package identity -->
    <PackageId>qyl.Analyzers</PackageId>
    <Description>Roslyn diagnostic analyzers for qyl observability patterns - OpenTelemetry, GenAI, Metrics, and Configuration</Description>
    <PackageTags>analyzers;roslyn;opentelemetry;genai;observability;metrics</PackageTags>

    <!-- Generate XML documentation for DocFX -->
    <GenerateDocumentationFile>true</GenerateDocumentationFile>

    <!-- Enable polyfills for netstandard2.0 TFM -->
    <InjectAllPolyfillsOnLegacy>true</InjectAllPolyfillsOnLegacy>

    <!-- Analyzer package settings -->
    <GeneratePackageOnBuild>false</GeneratePackageOnBuild>
    <IsPackable>true</IsPackable>
    <IncludeBuildOutput>false</IncludeBuildOutput>
    <GenerateDependencyFile>false</GenerateDependencyFile>
    <DevelopmentDependency>true</DevelopmentDependency>
    <NoPackageAnalysis>true</NoPackageAnalysis>
    <EnforceExtendedAnalyzerRules>true</EnforceExtendedAnalyzerRules>
    <NeutralLanguage>en</NeutralLanguage>
    <PackageReadmeFile>README.md</PackageReadmeFile>

    <!-- Analyzers don't have debug symbols - disable snupkg generation -->
    <IncludeSymbols>false</IncludeSymbols>

    <!-- Suppress analyzer rules:
         RS1025/RS1026/RS1041: Analyzer registration patterns - intentional design
         RS0030: Banned APIs - analyzer needs access to banned patterns to detect them
         CA2249: Use Contains - ns2.0 lacks Contains(char, StringComparison), must use IndexOf
         IDE0055: Multi-TFM formatting conflicts (dotnet format creates TFM merge markers)
         AL0026: SDK polyfill internals (expected use in TimeProvider impl)
         AL0012: Deprecated semconv strings - analyzer defines mapping of deprecated names -->
    <NoWarn>$(NoWarn);RS1025;RS1026;RS1041;RS0030;IDE0055;CA2249;AL0026;AL0012</NoWarn>
  </PropertyGroup>

  <ItemGroup>
    <Using Include="Microsoft.CodeAnalysis"/>
    <Using Include="Microsoft.CodeAnalysis.CSharp"/>
    <Using Include="Microsoft.CodeAnalysis.CSharp.Syntax"/>
    <Using Include="Microsoft.CodeAnalysis.Diagnostics"/>
    <Using Include="Microsoft.CodeAnalysis.Operations"/>
    <Using Include="System.Collections.Immutable"/>
    <Using Include="ANcpLua.Roslyn.Utilities"/>
  </ItemGroup>

  <ItemGroup>
    <!-- Runtime package - bundled into analyzer package via _AddAnalyzersToPackage target -->
    <PackageReference Include="ANcpLua.Roslyn.Utilities" PrivateAssets="all"/>
    <PackageReference Include="Microsoft.CodeAnalysis.Analyzers" PrivateAssets="all">
      <IncludeAssets>runtime; build; native; contentfiles; analyzers; buildtransitive</IncludeAssets>
    </PackageReference>
    <PackageReference Include="Microsoft.CodeAnalysis.CSharp" PrivateAssets="all"/>
  </ItemGroup>

  <ItemGroup>
    <Compile Update="Resources.Designer.cs" DesignTime="True" AutoGen="True" DependentUpon="Resources.resx"/>
    <EmbeddedResource Update="Resources.resx" Generator="ResXFileCodeGenerator" LastGenOutput="Resources.Designer.cs"/>
  </ItemGroup>

  <ItemGroup>
    <None Include="../../README.md" Pack="true" PackagePath="/" Condition="Exists('../../README.md')"/>
  </ItemGroup>

  <!-- Analyzer release tracking -->
  <ItemGroup>
    <AdditionalFiles Include="AnalyzerReleases/AnalyzerReleases.Shipped.md"/>
    <AdditionalFiles Include="AnalyzerReleases/AnalyzerReleases.Unshipped.md"/>
  </ItemGroup>

  <!-- CRITICAL: Pack ALL analyzer assemblies including dependencies (netstandard2.0 only) -->
  <PropertyGroup>
    <TargetsForTfmSpecificContentInPackage>$(TargetsForTfmSpecificContentInPackage);_AddAnalyzersToPackage</TargetsForTfmSpecificContentInPackage>
    <!-- Ensure dependencies are copied to output for bundling -->
    <CopyLocalLockFileAssemblies>true</CopyLocalLockFileAssemblies>
  </PropertyGroup>

  <Target Name="_AddAnalyzersToPackage" Condition="'$(TargetFramework)' == 'netstandard2.0'">
    <ItemGroup>
      <!-- Analyzer assemblies -->
      <TfmSpecificPackageFile Include="$(OutputPath)qyl.Analyzers.dll" PackagePath="analyzers/dotnet/cs"/>
      <!-- CodeFixes assembly (IDE integration) -->
      <TfmSpecificPackageFile Include="$(MSBuildThisFileDirectory)..\qyl.Analyzers.CodeFixes\bin\$(Configuration)\netstandard2.0\qyl.Analyzers.CodeFixes.dll" PackagePath="analyzers/dotnet/cs"/>
      <!-- Bundle Roslyn.Utilities dependency (required for analyzer runtime) -->
      <TfmSpecificPackageFile Include="$(OutputPath)ANcpLua.Roslyn.Utilities.dll" PackagePath="analyzers/dotnet/cs"/>
    </ItemGroup>
  </Target>
</Project>
