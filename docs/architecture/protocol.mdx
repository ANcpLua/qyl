---
title: "Protocol Architecture"
description: "Shared types and contracts across all components"
---

# Protocol Architecture

The protocol library defines shared types used by all qyl components.

## Design principles

1. **BCL Only**: No external package dependencies
2. **Leaf Dependency**: Other projects depend on protocol, never reverse
3. **Immutable Types**: Records with init-only properties
4. **Strongly-Typed IDs**: Prevent primitive obsession

## Strongly-typed IDs

| Type | Underlying | Format |
|------|------------|--------|
| `SessionId` | `Guid` | `550e8400-e29b-41d4-a716-446655440000` |
| `TraceId` | `ActivityTraceId` | 32-char hex |
| `SpanId` | `ActivitySpanId` | 16-char hex |
| `UnixNano` | `ulong` | Nanoseconds since Unix epoch |

## Core models

### SpanRecord

```csharp
public sealed record SpanRecord
{
    public required SpanId SpanId { get; init; }
    public required TraceId TraceId { get; init; }
    public SpanId? ParentSpanId { get; init; }
    public required string Name { get; init; }
    public required UnixNano StartTimeUnixNano { get; init; }
    public required UnixNano EndTimeUnixNano { get; init; }
    public required SpanKind Kind { get; init; }
    public required StatusCode StatusCode { get; init; }
    public GenAiSpanData? GenAi { get; init; }
}
```

### GenAiSpanData

Extracted `gen_ai.*` attributes:

```csharp
public sealed record GenAiSpanData
{
    public string? System { get; init; }           // gen_ai.system
    public string? RequestModel { get; init; }     // gen_ai.request.model
    public string? ResponseModel { get; init; }    // gen_ai.response.model
    public int? InputTokens { get; init; }         // gen_ai.usage.input_tokens
    public int? OutputTokens { get; init; }        // gen_ai.usage.output_tokens
    public decimal? CostUsd { get; init; }         // gen_ai.usage.cost
}
```

## Type ownership rules

| Owner | Types |
|-------|-------|
| `qyl.protocol` | All shared types (SpanRecord, SessionSummary, TraceNode, etc.) |
| `qyl.collector` | DuckDbStore, OtlpJsonSpanParser (internal only) |
| `qyl.dashboard` | React components, generated API types |
| `qyl.mcp` | MCP tool implementations |
