# =============================================================================
# qyl Architecture Specification
# Machine-readable project structure for AI assistants
# =============================================================================

meta:
  name: qyl
  description: AI Observability Platform for LLM/Agent telemetry
  version: 1.0.0
  target_framework: net10.0
  language: C# 14
  otel_version: 1.38.0

# =============================================================================
# PROJECT: qyl.collector (HTTP REST Backend)
# =============================================================================
collector:
  path: src/qyl.collector
  type: web_api
  framework: ASP.NET Core Minimal APIs
  ports:
    http: 5100
    otlp_http: 4318

  dependencies:
    - DuckDB.NET.Data
    - Google.Protobuf
    - Grpc.AspNetCore
    - System.IO.Hashing

  modules:
    auth:
      path: Auth/
      files:
        - name: TokenAuth.cs
          purpose: JWT and API key authentication middleware
          exports: [ TokenAuthHandler, TokenValidationOptions ]
        - name: TokenGenerator.cs
          purpose: Cryptographically secure token generation
          exports: [ TokenGenerator.Generate ]

    ingestion:
      path: Ingestion/
      files:
        - name: GenAiExtractor.cs
          purpose: Extract gen_ai.* semantic convention attributes
          exports: [ GenAiExtractor ]
          otel_attributes:
            - gen_ai.provider.name
            - gen_ai.request.model
            - gen_ai.response.model
            - gen_ai.operation.name
            - gen_ai.usage.input_tokens
            - gen_ai.usage.output_tokens
        - name: OtlpAttributes.cs
          purpose: OTLP attribute key constants
          exports: [ OtlpAttributes ]
        - name: OtlpJsonSpanParser.cs
          purpose: Parse OTLP JSON format spans
          exports: [ OtlpJsonSpanParser ]
        - name: OtlpTypes.cs
          purpose: OTLP wire format type definitions
          exports: [ OtlpSpan, OtlpResource, OtlpScope ]
        - name: SchemaNormalizer.cs
          purpose: Migrate deprecated OTel attributes to 1.38.0
          exports: [ SchemaNormalizer, SchemaVersion ]
          migrations:
            - from: gen_ai.system
              to: gen_ai.provider.name
            - from: gen_ai.usage.prompt_tokens
              to: gen_ai.usage.input_tokens
            - from: gen_ai.usage.completion_tokens
              to: gen_ai.usage.output_tokens

    storage:
      path: Storage/
      files:
        - name: DuckDbStore.cs
          purpose: DuckDB storage implementation with async writes
          exports: [ DuckDbStore, IDuckDbStore ]
          features:
            - channel_based_write_buffer
            - batch_insert
            - parquet_archival
            - query_by_session
            - query_by_time_range
        - name: DuckDbSchema.cs
          purpose: Schema definition and batch appender
          exports: [ DuckDbSchema ]
          tables:
            - name: spans
              columns:
                identity: [ trace_id, span_id, parent_span_id ]
                temporal: [ start_time, end_time ]
                core: [ name, kind, status, status_message ]
                promoted:
                  - service.name
                  - service.version
                  - gen_ai.provider.name
                  - gen_ai.request.model
                  - gen_ai.usage.input_tokens
                  - gen_ai.usage.output_tokens
                  - session.id
                overflow: attributes_json

    realtime:
      path: Realtime/
      files:
        - name: SseHub.cs
          purpose: SSE connection management and fan-out
          exports: [ SseHub ]
          pattern: pub_sub
        - name: SseEndpoints.cs
          purpose: SSE API endpoint registration
          exports: [ MapSseEndpoints ]
          endpoints:
            - GET /v1/stream/traces
            - GET /v1/stream/sessions/{id}
        - name: TelemetrySseStream.cs
          purpose: Async enumerable SSE streaming
          exports: [ TelemetrySseStream ]

    query:
      path: Query/
      files:
        - name: SessionAggregator.cs
          purpose: Aggregate spans into session summaries
          exports: [ SessionAggregator ]
          aggregations:
            - total_tokens
            - total_cost
            - span_count
            - duration
            - models_used

    primitives:
      path: Primitives/
      files:
        - name: TraceId.cs
          purpose: 32-char hex trace identifier
          exports: [ TraceId ]
        - name: SpanId.cs
          purpose: 16-char hex span identifier
          exports: [ SpanId ]
        - name: SessionId.cs
          purpose: Session identifier (string wrapper)
          exports: [ SessionId ]
        - name: UnixNano.cs
          purpose: Unix nanosecond timestamp
          exports: [ UnixNano ]

    mcp:
      path: Mcp/
      files:
        - name: McpServer.cs
          purpose: Model Context Protocol server for AI tool access
          exports: [ McpServer ]
          tools:
            - list_sessions
            - get_session
            - query_traces
            - get_metrics

    contracts:
      path: Contracts/
      files:
        - name: Contracts.cs
          purpose: API request/response DTOs
          exports: [ SessionResponse, TraceResponse, SpanResponse ]

    mapping:
      path: Mapping/
      files:
        - name: Mappers.cs
          purpose: Model-to-DTO transformations
          exports: [ SpanMapper, SessionMapper ]

  entry_point:
    file: Program.cs
    setup:
      - DuckDbStore registration
      - SseHub registration
      - OTLP HTTP endpoint
      - Minimal API routes
      - MCP server (optional)

# =============================================================================
# PROJECT: qyl.grpc (gRPC OTLP Receiver)
# =============================================================================
grpc:
  path: src/qyl.grpc
  type: class_library
  framework: gRPC + Protobuf
  ports:
    grpc: 4317

  dependencies:
    - Grpc.AspNetCore
    - Grpc.AspNetCore.Server.Reflection
    - Google.Protobuf

  modules:
    abstractions:
      path: Abstractions/
      files:
        - name: ITelemetryStore.cs
          purpose: Storage abstraction interface
          methods: [ StoreSpan, StoreLog, StoreMetric, Query* ]
        - name: ITelemetryBroadcaster.cs
          purpose: Real-time broadcast interface
          methods: [ Broadcast, Subscribe, Unsubscribe ]
        - name: ISessionAggregator.cs
          purpose: Session aggregation interface
          methods: [ GetSession, GetSessions, Aggregate ]
        - name: ITraceAggregator.cs
          purpose: Trace assembly interface
          methods: [ GetTrace, AssembleTrace ]
        - name: IServiceRegistry.cs
          purpose: Service discovery interface
          methods: [ Register, GetServices ]

    services:
      path: Services/
      files:
        - name: OtlpTraceService.cs
          purpose: gRPC trace receiver (OTLP/gRPC)
          proto: opentelemetry.proto.collector.trace.v1.TraceService
          rpc: Export(ExportTraceServiceRequest)
        - name: OtlpLogsService.cs
          purpose: gRPC logs receiver
          proto: opentelemetry.proto.collector.logs.v1.LogsService
          rpc: Export(ExportLogsServiceRequest)
        - name: OtlpMetricsService.cs
          purpose: gRPC metrics receiver
          proto: opentelemetry.proto.collector.metrics.v1.MetricsService
          rpc: Export(ExportMetricsServiceRequest)

    protocol:
      path: Protocol/
      files:
        - name: OtlpConverter.cs
          purpose: Protobuf to internal model conversion
          exports: [ OtlpConverter ]
          conversions:
            - Span (proto) → SpanModel
            - LogRecord (proto) → LogModel
            - Metric (proto) → MetricModel
        - name: OtlpHttpHandler.cs
          purpose: OTLP/HTTP endpoint handler
          endpoints:
            - POST /v1/traces
            - POST /v1/logs
            - POST /v1/metrics

    models:
      path: Models/
      files:
        - name: SpanModel.cs
          exports: [ SpanModel ]
        - name: TraceModel.cs
          exports: [ TraceModel ]
        - name: LogModel.cs
          exports: [ LogModel ]
        - name: MetricModel.cs
          exports: [ MetricModel ]
        - name: ResourceModel.cs
          exports: [ ResourceModel ]
        - name: AttributeValue.cs
          exports: [ AttributeValue ]

    stores:
      path: Stores/
      files:
        - name: InMemoryTelemetryStore.cs
          purpose: In-memory storage (dev/test)
          exports: [ InMemoryTelemetryStore ]
        - name: TraceAggregator.cs
          purpose: Assemble spans into traces
          exports: [ TraceAggregator ]
        - name: ServiceRegistry.cs
          purpose: Track discovered services
          exports: [ ServiceRegistry ]

    streaming:
      path: Streaming/
      files:
        - name: TelemetryBroadcaster.cs
          purpose: Channel-based pub/sub broadcaster
          exports: [ TelemetryBroadcaster ]
        - name: SseExtensions.cs
          purpose: SSE response helpers
          exports: [ WriteSseEvent ]
        - name: StreamingContracts.cs
          purpose: Streaming event DTOs
          exports: [ SpanBatch, TelemetryEvent ]

    protos:
      path: Protos/opentelemetry/proto/
      files:
        - collector/trace/v1/trace_service.proto
        - collector/logs/v1/logs_service.proto
        - collector/metrics/v1/metrics_service.proto
        - common/v1/common.proto
        - resource/v1/resource.proto
        - trace/v1/trace.proto
        - logs/v1/logs.proto
        - metrics/v1/metrics.proto

# =============================================================================
# PROJECT: qyl.providers (Unified AI Provider Factory)
# =============================================================================
providers:
  path: src/qyl.providers
  type: class_library
  purpose: Unified IChatClient factory for multiple AI providers

  dependencies:
    - Microsoft.Agents.AI
    - Mscc.GenerativeAI.Microsoft
    - OllamaSharp
    - Microsoft.Agents.AI.Hosting.OpenAI

  exports:
    factory_methods:
      - name: QylProviders.Gemini
        params: [ apiKey, model? ]
        default_model: gemini-2.5-flash
        env_var: GOOGLE_GENAI_API_KEY
      - name: QylProviders.OpenAi
        params: [ apiKey, model? ]
        default_model: gpt-4o-mini
        env_var: OPENAI_APIKEY
      - name: QylProviders.Ollama
        params: [ endpoint, model ]
        env_vars: [ OLLAMA_ENDPOINT, OLLAMA_MODEL_NAME ]

    env_methods:
      - QylProviders.GeminiFromEnv()
      - QylProviders.OpenAiFromEnv()
      - QylProviders.OllamaFromEnv()

    extensions:
      - name: AsAgent
        on: IChatClient
        returns: ChatClientAgent

# =============================================================================
# DATA FLOW
# =============================================================================
data_flow:
  ingestion:
    - source: SDK/Instrumentation
      protocol: OTLP/gRPC or OTLP/HTTP
      destination: qyl.grpc services
    - source: qyl.grpc
      transform: OtlpConverter
      destination: ITelemetryStore

  storage:
    - source: ITelemetryStore
      destination: DuckDbStore
      format: columnar (DuckDB)

  query:
    - source: REST API
      handler: Minimal API endpoints
      storage: DuckDbStore

  streaming:
    - source: ITelemetryStore
      broadcaster: TelemetryBroadcaster
      protocol: SSE
      destination: Dashboard/CLI

# =============================================================================
# API ENDPOINTS
# =============================================================================
api:
  rest:
    traces:
      - GET /v1/traces
      - GET /v1/traces/{traceId}
      - GET /v1/traces/{traceId}/spans
      - POST /v1/traces/search
    sessions:
      - GET /v1/sessions
      - GET /v1/sessions/{sessionId}
      - GET /v1/sessions/{sessionId}/traces
      - GET /v1/sessions/stats
    services:
      - GET /v1/services
      - GET /v1/services/{name}
    health:
      - GET /health/live
      - GET /health/ready

  streaming:
    sse:
      - GET /v1/stream/traces
      - GET /v1/stream/sessions/{id}
      - GET /v1/stream/metrics
      - GET /v1/stream/events

  otlp:
    http:
      - POST /v1/traces (OTLP/HTTP)
      - POST /v1/logs (OTLP/HTTP)
      - POST /v1/metrics (OTLP/HTTP)
    grpc:
      - TraceService.Export (OTLP/gRPC)
      - LogsService.Export (OTLP/gRPC)
      - MetricsService.Export (OTLP/gRPC)
