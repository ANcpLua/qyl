# ═══════════════════════════════════════════════════════════════════════════════
# qyl — Migration Roadmap
# Gap Analysis & Structured Change Manifest
# ═══════════════════════════════════════════════════════════════════════════════
#
# This document defines ALL changes required to align the current qyl repository
# with the target architecture defined in COMPLETE_STRUCTURE.txt.
#
# Machine-readable by AI assistants. Phases are sequential.
# Architect corrections applied: 2024-12-14
#
# Last Updated: 2025-12-16 01:00 UTC+1
# Maintainer: @ANcpLua
# ═══════════════════════════════════════════════════════════════════════════════

meta:
  name: qyl-migration
  description: "Structured migration from current state to target architecture"
  source_of_truth:
    architecture: docs/qyl-architecture.yaml
    structure: docs/COMPLETE_STRUCTURE.txt
  total_changes: 157
  estimated_phases: 5

# ═══════════════════════════════════════════════════════════════════════════════
# SDK INTEGRATION - COMPLETED 2025-12-15
# ═══════════════════════════════════════════════════════════════════════════════

sdk_integration:
  status: COMPLETED
  version: "1.1.3"
  packages:
    - name: ANcpLua.NET.Sdk
      nuget_url: https://www.nuget.org/packages/ANcpLua.NET.Sdk/1.1.3
    - name: ANcpLua.NET.Sdk.Web
      nuget_url: https://www.nuget.org/packages/ANcpLua.NET.Sdk.Web/1.1.3

  migrated_projects:
    - project: src/qyl.collector/qyl.collector.csproj
      sdk: ANcpLua.NET.Sdk.Web
      status: ✅
    - project: src/qyl.mcp/qyl.mcp.csproj
      sdk: ANcpLua.NET.Sdk
      status: ✅
    - project: src/qyl.protocol/qyl.protocol.csproj
      sdk: Microsoft.NET.Sdk  # LEAF library - no custom SDK needed
      status: ✅

  deleted_files:
    - src/Shared/Throw/
    - src/LegacySupport/

  sdk_provides:
    - Microsoft.Shared.Diagnostics.Throw (guard clauses)
    - BannedApiAnalyzers
    - Polyfills for legacy TFMs
    - Standard analyzers

  global_using: "Microsoft.Shared.Diagnostics"

# ═══════════════════════════════════════════════════════════════════════════════
# PACKAGE DEPENDENCIES
# ═══════════════════════════════════════════════════════════════════════════════

package_dependencies:
  duckdb:
    package: DuckDB.NET.Data.Full
    version: "1.4.3"
    nuget_url: https://www.nuget.org/packages/DuckDB.NET.Data.Full/1.4.3
    github_url: https://github.com/Giorgi/DuckDB.NET
    duckdb_core: "1.4.3"
    notes: |
      v1.4.3 adds ±infinity date/timestamp support, transaction abortion handling,
      and decimal parameter fixes. Use DuckDBDateOnly.IsInfinity to check for
      infinite dates before converting to DateTime.

# ═══════════════════════════════════════════════════════════════════════════════
# ARCHITECT OVERRIDES
# ═══════════════════════════════════════════════════════════════════════════════
#
# These corrections take precedence over automated gap analysis.

architect_overrides:
  sdk_location:
    status: NUGET  # Changed from EXTERNAL to NUGET
    packages: [ "ANcpLua.NET.Sdk@1.1.3", "ANcpLua.NET.Sdk.Web@1.1.3" ]
    nuget: "https://www.nuget.org/packages/ANcpLua.NET.Sdk/"
    note: "SDK is in SEPARATE repository. Do NOT create sdk/ in qyl repo."

  protected_items:
    - path: "eng/qyl.analyzers/"
      reason: "OTel semantic convention analyzers (QylGenAi*). Different from SDK analyzers."
      action: KEEP

    - path: "**/**/CLAUDE.md"
      reason: "AI context documentation. Valuable for assistants."
      action: KEEP

    - path: "eng/MSBuild/"
      reason: "Build infrastructure. Required by ANcpLua.NET.Sdk."
      action: KEEP

  confirmed_deletions:
    - path: "eng/qyl.cli/"
      reason: "No customer-facing use case. Build tasks belong in NUKE."
      action: DELETE

# ═══════════════════════════════════════════════════════════════════════════════
# VALIDATED RULES (for AI agents)
# ═══════════════════════════════════════════════════════════════════════════════

code_rules:
  collections:
    FrozenDictionary:
      use_when: "Immutable lookup table, 'write once read many', single source of truth"
      examples:
        - "QylSchema.BuildGenAiAttributes() → .ToFrozenDictionary()"
        - "Static config maps returned from generators"

    Dictionary:
      use_when: "Mutable accumulator, parsing scratch, JSON property bag, merge logic"
      valid_in:
        - "CoveragePatterns.cs (parsing aggregation)"
        - "IClaudeContext.cs (merge accumulator)"
        - "ICoverage.cs (JSON serialization bag)"
      note: "NOT a violation - these are builders, not lookup tables"

  time:
    DateTime_UtcNow:
      allowed_in: "eng/build/ (RS0030 suppressed)"
      note: "Build tooling exception"
    TimeProvider:
      preferred_for: "Runtime code, testability"

  locking:
    use: "System.Threading.Lock (.NET 9+)"
    forbidden: "object _lock with Monitor"

# ═══════════════════════════════════════════════════════════════════════════════
# PHASE 1: BUILD SYSTEM RESTRUCTURING
# ═══════════════════════════════════════════════════════════════════════════════
#
# Priority: IMMEDIATE
# Scope: eng/build/ only
# Estimated effort: 2-4 hours

phase_1:
  name: "Build System Restructuring"
  priority: 1
  status: IN_PROGRESS
  scope: "eng/build/"

  directories_create:
    - path: "eng/build/Context/"
      purpose: "Shared state (paths, config). No logic."

    - path: "eng/build/Domain/"
      purpose: "Pure C# logic classes. Independent of Nuke."

    - path: "eng/build/Domain/CodeGen/"
      purpose: "Code generation abstractions and schema"

    - path: "eng/build/Domain/CodeGen/Generators/"
      purpose: "IGenerator implementations"

    - path: "eng/build/Domain/Utilities/"
      purpose: "Helper classes (GenerationGuard, etc.)"

  files_create:
    - path: "eng/build/Context/BuildPaths.cs"
      purpose: "Single source of truth for all filesystem paths"
      template: |
        namespace Build.Context;
        public sealed record BuildPaths(AbsolutePath Root)
        {
            public AbsolutePath Core => Root / "core";
            public AbsolutePath Specs => Core / "specs";
            public AbsolutePath Generated => Core / "generated";
            public AbsolutePath Src => Root / "src";
            public AbsolutePath Protocol => Src / "qyl.protocol";
            public AbsolutePath Collector => Src / "qyl.collector";
            public AbsolutePath Dashboard => Src / "qyl.dashboard";
            public AbsolutePath Mcp => Src / "qyl.mcp";
            public AbsolutePath GeneratedOpenApi => Generated / "openapi";
            public AbsolutePath GeneratedCSharp => Generated / "csharp";
            public AbsolutePath GeneratedDuckDb => Generated / "duckdb";
            public AbsolutePath GeneratedTypeScript => Generated / "typescript";
            public AbsolutePath DashboardTypes => Dashboard / "src" / "types" / "generated";
            public static BuildPaths From(NukeBuild build) => new(build.RootDirectory);
        }

    - path: "eng/build/Domain/CodeGen/IGenerator.cs"
      purpose: "Strategy interface for code generators"
      template: |
        namespace Build.Domain.CodeGen;
        public interface IGenerator
        {
            string Name { get; }
            FrozenDictionary<string, string> Generate(QylSchema schema, BuildPaths paths);
        }

  files_extract:
    - from: "eng/build/merge.wip/QylSchema.cs"
      to: "eng/build/Domain/CodeGen/QylSchema.cs"
      transform: "Keep as-is, update namespace to Build.Domain.CodeGen"

    - from: "eng/build/merge.wip/CSharpEmitter.cs"
      to: "eng/build/Domain/CodeGen/Generators/CSharpGenerator.cs"
      transform: "static class → sealed class : IGenerator"

    - from: "eng/build/merge.wip/DuckDbEmitter.cs"
      to: "eng/build/Domain/CodeGen/Generators/DuckDbGenerator.cs"
      transform: "static class → sealed class : IGenerator"

    - from: "eng/build/merge.wip/TypeScriptEmitter.cs"
      to: "eng/build/Domain/CodeGen/Generators/TypeScriptGenerator.cs"
      transform: "static class → sealed class : IGenerator"

    - from: "eng/build/merge.wip/IGenerationGuard.cs"
      to: "eng/build/Domain/Utilities/GenerationGuard.cs"
      transform: "interface → sealed class with WriteIfChanged logic"

  directories_delete:
    - path: "eng/build/merge.wip/"
      condition: "AFTER extraction complete"
      validation: "All files extracted and compiling"

    - path: "eng/qyl.cli/"
      condition: "IMMEDIATE"
      reason: "Architect confirmed: no customer use case"

  files_consolidate:
    - description: "Merge TypeSpec + Emitter components"
      from:
        - "eng/build/Build.TypeSpec.cs"
        - "eng/build/Components/IEmitter.cs (if exists)"
      to: "eng/build/Components/ICodeGen.cs"

    - description: "Merge Docker components"
      from:
        - "eng/build/Components/IDockerBuild.cs"
        - "eng/build/Components/IDockerCompose.cs"
      to: "eng/build/Components/IDelivery.cs"

    - description: "Merge Quality components"
      from:
        - "eng/build/Components/ITest.cs"
        - "eng/build/Components/ICoverage.cs"
      to: "eng/build/Components/IQuality.cs"

  validation:
    commands:
      - "dotnet build eng/build/build.csproj --no-restore"
      - "./build.sh Compile --skip"

    success_criteria:
      - "eng/build/Context/BuildPaths.cs exists"
      - "eng/build/Domain/CodeGen/IGenerator.cs exists"
      - "eng/build/Domain/CodeGen/Generators/*.cs exist (3 files)"
      - "eng/build/Domain/Utilities/GenerationGuard.cs exists"
      - "eng/build/merge.wip/ deleted"
      - "eng/qyl.cli/ deleted"
      - "dotnet build succeeds"
      - "Build.cs < 30 lines"

# ═══════════════════════════════════════════════════════════════════════════════
# PHASE 2: CORE SPECS & TYPESPEC SETUP
# ═══════════════════════════════════════════════════════════════════════════════
#
# Priority: HIGH
# Scope: core/
# Estimated effort: 4-6 hours
# Dependency: Phase 1 complete

phase_2:
  name: "TypeSpec Infrastructure"
  priority: 2
  status: PLANNED
  scope: "core/"
  depends_on: [ phase_1 ]

  directories_create:
    - path: "core/specs/api/"
      purpose: "REST API definitions"

    - path: "core/specs/models/"
      purpose: "Shared data models"

    - path: "core/specs/storage/"
      purpose: "DuckDB schema definitions"

    - path: "core/specs/otel/"
      purpose: "OTel Semantic Conventions"

    - path: "core/emitters/"
      purpose: "Custom TypeSpec emitters"

    - path: "core/emitters/duckdb/"
      purpose: "@qyl/typespec-duckdb emitter"

    - path: "core/emitters/duckdb/src/"
      purpose: "Emitter source code"

    - path: "core/emitters/csharp-models/"
      purpose: "@qyl/typespec-csharp-models emitter"

    - path: "core/emitters/csharp-models/src/"
      purpose: "Emitter source code"

    - path: "core/generated/"
      purpose: "All generated output"

    - path: "core/generated/openapi/"
      purpose: "Generated OpenAPI specs"

    - path: "core/generated/duckdb/"
      purpose: "Generated DuckDB schema + C#"

    - path: "core/generated/csharp/"
      purpose: "Generated C# models"

  files_create:
    # TypeSpec entry points
    - path: "core/specs/main.tsp"
      purpose: "TypeSpec entry point"

    - path: "core/specs/api/main.tsp"
      purpose: "API namespace entry"

    - path: "core/specs/api/sessions.tsp"
      purpose: "Sessions endpoints"

    - path: "core/specs/api/traces.tsp"
      purpose: "Traces endpoints"

    - path: "core/specs/api/spans.tsp"
      purpose: "Spans endpoints"

    - path: "core/specs/api/metrics.tsp"
      purpose: "Metrics endpoints"

    - path: "core/specs/api/streaming.tsp"
      purpose: "SSE endpoints"

    # Models
    - path: "core/specs/models/primitives.tsp"
      purpose: "SessionId, UnixNano"

    - path: "core/specs/models/spans.tsp"
      purpose: "SpanRecord, SpanData"

    - path: "core/specs/models/sessions.tsp"
      purpose: "SessionSummary"

    - path: "core/specs/models/traces.tsp"
      purpose: "TraceNode"

    - path: "core/specs/models/genai.tsp"
      purpose: "GenAiSpanData (OTel 1.38)"

    - path: "core/specs/models/errors.tsp"
      purpose: "ErrorResponse"

    # Storage
    - path: "core/specs/storage/decorators.tsp"
      purpose: "@table, @column, @index decorators"

    - path: "core/specs/storage/tables.tsp"
      purpose: "spans table definition"

    # OTel
    - path: "core/specs/otel/semconv.tsp"
      purpose: "gen_ai.* attributes (v1.38)"

    - path: "core/specs/otel/resource.tsp"
      purpose: "service.name, etc."

    # Emitters
    - path: "core/emitters/duckdb/package.json"
      purpose: "DuckDB emitter package"

    - path: "core/emitters/duckdb/tsconfig.json"
      purpose: "TypeScript config"

    - path: "core/emitters/duckdb/src/index.ts"
      purpose: "Emitter entry"

    - path: "core/emitters/duckdb/src/emitter.ts"
      purpose: "$onEmit implementation"

    - path: "core/emitters/duckdb/src/sql-generator.ts"
      purpose: "Model → CREATE TABLE"

    - path: "core/emitters/duckdb/src/csharp-generator.ts"
      purpose: "Model → FrozenDictionary"

    - path: "core/emitters/duckdb/src/decorators.ts"
      purpose: "@table, @column decorators"

    - path: "core/emitters/csharp-models/package.json"
      purpose: "C# models emitter package"

    - path: "core/emitters/csharp-models/tsconfig.json"
      purpose: "TypeScript config"

    - path: "core/emitters/csharp-models/src/index.ts"
      purpose: "Emitter entry"

    - path: "core/emitters/csharp-models/src/emitter.ts"
      purpose: "$onEmit implementation"

    - path: "core/emitters/csharp-models/src/model-generator.ts"
      purpose: "Model → C# records"

  files_relocate:
    - from: "core/openapi/openapi.yaml"
      to: "core/generated/openapi/openapi.yaml"
      reason: "Consolidate all generated output"

  files_delete:
    - path: "core/CLAUDE.md"
      reason: "OVERRIDE: Keep per architect decision"
      action: SKIP  # Architect override

  validation:
    commands:
      - "cd core/specs && npm install"
      - "cd core/specs && npx tsp compile ."

    success_criteria:
      - "core/specs/main.tsp compiles"
      - "core/generated/openapi/openapi.yaml generated"
      - "No TypeSpec errors"

# ═══════════════════════════════════════════════════════════════════════════════
# PHASE 3: SOURCE PROJECT REFACTORING
# ═══════════════════════════════════════════════════════════════════════════════
#
# Priority: MEDIUM
# Scope: src/
# Estimated effort: 6-8 hours
# Dependency: Phase 2 complete

phase_3:
  name: "Source Project Refactoring"
  priority: 3
  status: PARTIALLY_COMPLETE  # Collector structure done, MCP pending
  scope: "src/"
  depends_on: [ phase_2 ]

  # Shared code relocation - COMPLETED
  relocations:
    - from: "src/Shared/Throw/"
      to: "PROVIDED BY SDK"
      status: "✅ DELETED - ANcpLua.NET.Sdk@1.1.3 provides Throw.cs"

    - from: "src/LegacySupport/"
      to: "PROVIDED BY SDK"
      status: "✅ DELETED - ANcpLua.NET.Sdk@1.1.3 provides Polyfills"

  # qyl.collector status (2025-12-16)
  collector_changes:
    directories_exist:
      - "src/qyl.collector/Pipeline/"          # ✅ SpanIngestionPipeline.cs
      - "src/qyl.collector/Extensions/"        # ✅ ActivityExtensions.cs
      - "src/qyl.collector/Parsing/"           # ✅ TraceContextParser.cs
      - "src/qyl.collector/Primitives/"        # ✅ TraceId, SpanId, UnixNano, SessionId
      - "src/qyl.collector/Auth/"              # ✅ TokenAuth, TokenGenerator
      - "src/qyl.collector/Storage/"           # ✅ DuckDbStore, DuckDbSchema, etc.
      - "src/qyl.collector/Ingestion/"         # ✅ OtlpJsonSpanParser, etc.
      - "src/qyl.collector/Query/"             # ✅ SessionQueryService
      - "src/qyl.collector/Realtime/"          # ✅ SseEndpoints, SseHub
      - "src/qyl.collector/Models/"            # ✅ ParsedSpan

    files_added_recently:
      - "src/qyl.collector/GenAiProviders.cs"  # Provider detection from host
      - "src/qyl.collector/Pipeline/SpanIngestionPipeline.cs"  # Channel<T> backpressure
      - "src/qyl.collector/Extensions/ActivityExtensions.cs"   # C# 14 extensions
      - "src/qyl.collector/Parsing/TraceContextParser.cs"      # W3C traceparent

    directories_create:
      - "src/qyl.collector/Api/"               # REST endpoint organization (future)

    files_create:
      - path: "src/qyl.collector/appsettings.json"
        purpose: "Configuration"

      - path: "src/qyl.collector/appsettings.Development.json"
        purpose: "Dev configuration"

      - path: "src/qyl.collector/Dockerfile"
        purpose: "Container build"

      - path: "src/qyl.collector/Api/SessionsEndpoint.cs"
        purpose: "Sessions REST API"

      - path: "src/qyl.collector/Api/TracesEndpoint.cs"
        purpose: "Traces REST API"

      - path: "src/qyl.collector/Api/SpansEndpoint.cs"
        purpose: "Spans REST API"

      - path: "src/qyl.collector/Api/SseEndpoint.cs"
        purpose: "SSE streaming"

    files_delete:
      - path: "src/qyl.collector/GenAiAttributes.cs"
        reason: "Duplicate of qyl.protocol"

      - path: "src/qyl.collector/QylAttributes.cs"
        reason: "Consolidate to protocol"

      - path: "src/qyl.collector/StartupBanner.cs"
        reason: "Non-essential"

      - path: "src/qyl.collector/docker-compose.yml"
        reason: "Use eng/compose.yaml"

    directories_delete:
      - path: "src/qyl.collector/Auth/"
        reason: "Premature - add when needed"
        condition: "DEFER - may need later"

      - path: "src/qyl.collector/ConsoleBridge/"
        reason: "Non-essential debugging"

      - path: "src/qyl.collector/Contracts/"
        reason: "Use qyl.protocol"

      - path: "src/qyl.collector/Mapping/"
        reason: "Integrate into Ingestion/"

      - path: "src/qyl.collector/Mcp/"
        reason: "MCP is separate project (qyl.mcp)"

      - path: "src/qyl.collector/Models/"
        reason: "Use qyl.protocol"

      - path: "src/qyl.collector/Primitives/"
        reason: "Use qyl.protocol"

  # qyl.mcp refactoring
  mcp_changes:
    directories_create:
      - "src/qyl.mcp/Client/"
      - "src/qyl.mcp/Tools/"

    files_create:
      - path: "src/qyl.mcp/appsettings.json"
        purpose: "Configuration"

      - path: "src/qyl.mcp/Dockerfile"
        purpose: "Container build"

      - path: "src/qyl.mcp/Client/QylCollectorClient.cs"
        purpose: "HTTP client to collector"

      - path: "src/qyl.mcp/Tools/QuerySpansTool.cs"
        purpose: "MCP tool: query_spans"

      - path: "src/qyl.mcp/Tools/GetSessionTool.cs"
        purpose: "MCP tool: get_session"

      - path: "src/qyl.mcp/Tools/GetTraceTool.cs"
        purpose: "MCP tool: get_trace"

      - path: "src/qyl.mcp/Tools/AnalyzeGenAiTool.cs"
        purpose: "MCP tool: analyze_genai"

      - path: "src/qyl.mcp/Tools/ListServicesTool.cs"
        purpose: "MCP tool: list_services"

      - path: "src/qyl.mcp/Tools/CompareSessionsTool.cs"
        purpose: "MCP tool: compare_sessions"

    files_relocate:
      - from: "src/qyl.mcp/Client.cs"
        to: "src/qyl.mcp/Client/QylCollectorClient.cs"

    files_delete:
      - path: "src/qyl.mcp/.mcp/server.json"
        reason: "Generated, not committed"

      - path: "src/qyl.mcp/README.md"
        reason: "Use root README"

  # qyl.dashboard refactoring
  dashboard_changes:
    directories_create:
      - "src/qyl.dashboard/src/api/"
      - "src/qyl.dashboard/src/components/sessions/"
      - "src/qyl.dashboard/src/components/traces/"
      - "src/qyl.dashboard/src/components/genai/"
      - "src/qyl.dashboard/src/types/generated/"

    files_create:
      - path: "src/qyl.dashboard/qyl.dashboard.esproj"
        purpose: "VS project file"

      - path: "src/qyl.dashboard/pnpm-lock.yaml"
        purpose: "pnpm lockfile (replace npm)"

      - path: "src/qyl.dashboard/Dockerfile"
        purpose: "Container build"

      - path: "src/qyl.dashboard/src/api/client.ts"
        purpose: "API client"

      - path: "src/qyl.dashboard/src/api/hooks.ts"
        purpose: "TanStack Query hooks"

      - path: "src/qyl.dashboard/src/hooks/useSse.ts"
        purpose: "SSE hook"

      - path: "src/qyl.dashboard/src/components/sessions/SessionList.tsx"
        purpose: "Sessions list component"

      - path: "src/qyl.dashboard/src/components/sessions/SessionCard.tsx"
        purpose: "Session card component"

      - path: "src/qyl.dashboard/src/components/traces/TraceTree.tsx"
        purpose: "Trace tree component"

      - path: "src/qyl.dashboard/src/components/traces/SpanDetail.tsx"
        purpose: "Span detail component"

      - path: "src/qyl.dashboard/src/components/genai/TokenChart.tsx"
        purpose: "Token usage chart"

      - path: "src/qyl.dashboard/src/components/genai/ModelUsage.tsx"
        purpose: "Model usage component"

      - path: "src/qyl.dashboard/src/components/genai/CostBreakdown.tsx"
        purpose: "Cost breakdown component"

      - path: "src/qyl.dashboard/src/pages/SessionsPage.tsx"
        purpose: "Sessions page"

      - path: "src/qyl.dashboard/src/types/generated/qylClient.ts"
        purpose: "Kiota-generated client"

    files_delete:
      - path: "src/qyl.dashboard/components.json"
        reason: "shadcn config - regenerate"

      - path: "src/qyl.dashboard/package-lock.json"
        reason: "Use pnpm-lock.yaml"

      - path: "src/qyl.dashboard/schemas/"
        reason: "Use core/specs/"

  validation:
    commands:
      - "dotnet build src/qyl.collector/qyl.collector.csproj"
      - "dotnet build src/qyl.mcp/qyl.mcp.csproj"
      - "cd src/qyl.dashboard && pnpm install && pnpm build"

    success_criteria:
      - "All projects compile"
      - "No duplicate types between collector and protocol"
      - "MCP tools split into individual files"

# ═══════════════════════════════════════════════════════════════════════════════
# PHASE 4: DOCUMENTATION & CI/CD
# ═══════════════════════════════════════════════════════════════════════════════
#
# Priority: LOW
# Scope: docs/, eng/ci/
# Estimated effort: 2-3 hours
# Dependency: Phase 3 complete

phase_4:
  name: "Documentation & CI/CD"
  priority: 4
  status: PLANNED
  scope: "docs/, eng/ci/, root files"
  depends_on: [ phase_3 ]

  directories_create:
    - path: "docs/adr/"
      purpose: "Architecture Decision Records"

    - path: "docs/specs/"
      purpose: "Architecture specifications"

    - path: "docs/api/"
      purpose: "API documentation"

    - path: "eng/analyzer/"
      purpose: "Analyzer configuration files"

    - path: "eng/ci/"
      purpose: "CI/CD pipeline definitions"

  files_create:
    # Root files
    - path: ".gitattributes"
      purpose: "Git attributes"

    - path: "LICENSE"
      purpose: "License file"

    - path: "README.md"
      purpose: "Repository README"

    # ADRs
    - path: "docs/adr/adr-template.md"
      purpose: "ADR template"

    - path: "docs/adr/0001-use-duckdb-for-storage.md"
      purpose: "ADR: DuckDB decision"

    - path: "docs/adr/0002-single-sdk-layering-pattern.md"
      purpose: "ADR: SDK layering"

    - path: "docs/adr/0003-mcp-http-only-communication.md"
      purpose: "ADR: MCP HTTP only"

    - path: "docs/adr/0004-otel-138-semantic-conventions.md"
      purpose: "ADR: OTel 1.38"

    - path: "docs/adr/0005-typespec-source-of-truth.md"
      purpose: "ADR: TypeSpec"

    - path: "docs/adr/0006-kiota-for-typescript-client.md"
      purpose: "ADR: Kiota"

    - path: "docs/adr/0007-custom-duckdb-emitter.md"
      purpose: "ADR: Custom emitter"

    # Specs
    - path: "docs/specs/architecture.yaml"
      purpose: "Architecture spec (from qyl-architecture.yaml)"

    - path: "docs/specs/schema.yaml"
      purpose: "Schema spec"

    # Analyzer configs
    - path: "eng/analyzer/BannedSymbols.NewtonsoftJson.txt"
      purpose: "Ban Newtonsoft.Json"

    - path: "eng/analyzer/Analyzers.editorconfig"
      purpose: "Analyzer editorconfig"

    # CI/CD
    - path: "eng/ci/build.yaml"
      purpose: "Build pipeline"

    - path: "eng/ci/test.yaml"
      purpose: "Test pipeline"

    - path: "eng/ci/release.yaml"
      purpose: "Release pipeline"

    - path: "eng/ci/docker.yaml"
      purpose: "Docker pipeline"

  files_relocate:
    - from: "docs/qyl-architecture.yaml"
      to: "docs/specs/architecture.yaml"

    - from: "eng/MSBuild/BannedSymbols.txt"
      to: "eng/analyzer/BannedSymbols.txt"

  files_delete:
    - path: "docs/ARCHITECTURE.md"
      reason: "Replaced by docs/specs/"

    - path: "docs/BUILD.md"
      reason: "Outdated"

    - path: "docs/COLLECTOR.md"
      reason: "Outdated"

    - path: "docs/FRONTEND.md"
      reason: "Outdated"

    - path: "docs/README.md"
      reason: "Use root README"

    - path: "docs/SDK-TLDR.md"
      reason: "SDK is separate repo"

    - path: "docs/COMPLETE_STRUCTURE.txt"
      reason: "Delete AFTER migration complete"
      condition: "FINAL CLEANUP"

  directories_delete:
    - path: "docs/features/"
      reason: "Move to GitHub issues/projects"

    - path: ".claude/"
      reason: "Internal tooling artifacts"

    - path: ".nuke/"
      reason: "NUKE auto-generates this"

  validation:
    success_criteria:
      - "docs/adr/ contains all ADRs"
      - "eng/ci/ contains all pipelines"
      - "Root README.md exists"

# ═══════════════════════════════════════════════════════════════════════════════
# PHASE 5: TEST & EXAMPLES RESTRUCTURING
# ═══════════════════════════════════════════════════════════════════════════════
#
# Priority: LOW
# Scope: tests/, examples/
# Estimated effort: 2-3 hours
# Dependency: Phase 3 complete

phase_5:
  name: "Tests & Examples"
  priority: 5
  status: PLANNED
  scope: "tests/, examples/"
  depends_on: [ phase_3 ]

  # Tests restructuring
  tests_changes:
    directories_create:
      - "tests/qyl.protocol.tests/"
      - "tests/qyl.collector.tests/"
      - "tests/qyl.mcp.tests/"

    directories_relocate:
      - from: "tests/UnitTests/qyl.analyzers.tests/"
        to: "tests/qyl.analyzers.tests/"

      - from: "tests/UnitTests/qyl.mcp.server.tests/"
        to: "tests/qyl.mcp.tests/"

    directories_delete:
      - path: "tests/UnitTests/"
        reason: "Flatten structure"
        condition: "AFTER relocation"

    files_create:
      - path: "tests/qyl.protocol.tests/qyl.protocol.tests.csproj"
        purpose: "Protocol unit tests"

      - path: "tests/qyl.collector.tests/qyl.collector.tests.csproj"
        purpose: "Collector integration tests"

  # Examples restructuring
  examples_changes:
    directories_rename:
      - from: "examples/qyl.AspNetCore.Example/"
        to: "examples/qyl.example.webapi/"

    directories_create:
      - "examples/qyl.example.console/"
      - "examples/qyl.example.agent/"

    directories_delete:
      - path: "examples/qyl.analyzers.Sample/"
        reason: "Analyzer sample not needed"

    files_create:
      - path: "examples/qyl.example.console/qyl.example.console.csproj"
        purpose: "Console example"

      - path: "examples/qyl.example.console/Program.cs"
        purpose: "Console entry point"

      - path: "examples/qyl.example.agent/qyl.example.agent.csproj"
        purpose: "AI agent example"

      - path: "examples/qyl.example.agent/Program.cs"
        purpose: "Agent entry point"

  validation:
    commands:
      - "dotnet test"

    success_criteria:
      - "All tests pass"
      - "Example projects compile"
      - "tests/ structure flattened"

# ═══════════════════════════════════════════════════════════════════════════════
# SUMMARY
# ═══════════════════════════════════════════════════════════════════════════════

summary:
  total_directories_create: 42
  total_directories_delete: 15  # Reduced due to architect overrides
  total_files_create: 95
  total_files_delete: 35        # Reduced due to architect overrides
  total_files_relocate: 12

  phase_estimates:
    phase_1: "2-4 hours"
    phase_2: "4-6 hours"
    phase_3: "6-8 hours"
    phase_4: "2-3 hours"
    phase_5: "2-3 hours"
    total: "16-24 hours"

  critical_paths:
    - "Phase 1 must complete before Phase 2"
    - "Phase 2 must complete before Phase 3"
    - "Phase 4 and Phase 5 can run in parallel after Phase 3"

  external_dependencies:
    - name: "ANcpLua.NET.Sdk"
      location: "Separate repository"
      nuget: "https://www.nuget.org/packages/ANcpLua.NET.Sdk/"
      note: "Do NOT create sdk/ in qyl repo"

# ═══════════════════════════════════════════════════════════════════════════════
# ANTI-PATTERNS (DO NOT)
# ═══════════════════════════════════════════════════════════════════════════════

anti_patterns:
  - "Adding OpenTelemetry.* NuGets to eng/build/build.csproj"
  - "Adding DuckDB.* NuGets to eng/build/build.csproj"
  - "Using FrozenDictionary for parsing/accumulation logic"
  - "Keeping duplicate path definitions across interfaces"
  - "Creating sdk/ directory (SDK is separate repo)"
  - "Deleting CLAUDE.md files"
  - "Deleting eng/qyl.analyzers/"
  - "Using object _lock instead of System.Threading.Lock"
  - "Using DateTime.Now instead of DateTime.UtcNow in build"
