# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# qyl â€” AI Observability Platform
# FINAL ARCHITECTURE SPECIFICATION (v2.0)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# SINGLE SOURCE OF TRUTH â€” Best of Both Worlds Edition
#
# This document consolidates architecture specifications.
# DuckDB 1.4.3 API Guide is now in CLAUDE.md.
#
# Last Updated: 2025-12-16
# Lead Architect: @ANcpLua
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

meta:
  name: qyl
  full_name: "qyl AI Observability Platform"
  description: |
    Backend system receiving OpenTelemetry telemetry, extracting gen_ai.*
    semantic convention attributes, storing in DuckDB, exposing REST/SSE APIs
    for dashboards and AI agents via MCP.
  version: 1.0.0
  target_framework: net10.0
  language_version: "C# 14"
  otel_semconv_version: "1.38.0"
  solution: "qyl.slnx"  # VS 17.12+

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# MIGRATION CONTEXT â€” Current Project Status
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

migration_context:
  current_phase: "Phase 3"
  last_updated: "2025-12-16"
  build_status: "GREEN"

  phases:
    phase_1:
      name: "Infrastructure & SDK"
      status: "COMPLETED"
      icon: "âœ…"
      completed_items:
        - "NUKE build system operational"
        - "ANcpLua.NET.Sdk v1.1.3 integrated via NuGet"
        - "Repository cleaned from boilerplate"
        - "global.json SDK pinning configured"
        - "Directory.Build.props/targets established"
        - "Central Package Management (CPM) enabled"

    phase_2:
      name: "Storage Layer"
      status: "COMPLETED"
      icon: "âœ…"
      completed_items:
        - "DuckDbStore.cs - OTel 1.38 schema with quoted columns"
        - "DuckDbStore.cs - Separate write connection (channel-buffered)"
        - "DuckDbStore.cs - Pooled read connections (ObjectPool + SemaphoreSlim)"
        - "DuckDbStore.cs - ReadLease RAII struct"
        - "DuckDbStore.cs - WriteJob abstraction (FireAndForget + WriteJob<T>)"
        - "DuckDbStore.cs - Metrics (dropped_jobs, dropped_spans)"
        - "DuckDbStore.cs - Graceful shutdown (3s+1s timeout)"
        - "SpanRecord.cs - TokensIn/Out changed to long (BIGINT)"
        - "SpanRecord.cs - ServiceName added"

    phase_3:
      name: "Query & API Layer"
      status: "IN_PROGRESS"
      icon: "â³"
      current_tasks:
        - "SessionQueryService.cs - Migrate to OTel 1.38 columns"
        - "Program.cs - Wire up DuckDbStore with DI"
        - "Program.cs - Add REST endpoints"
      next_steps:
        - "VS-02: List Sessions vertical slice"
        - "VS-03: View Trace Tree"

    phase_4:
      name: "MCP & Dashboard"
      status: "PLANNED"
      icon: "ğŸ“…"
      planned_items:
        - "qyl.mcp tools (GetSessionTool, QuerySpansTool)"
        - "qyl.dashboard React pages"
        - "Integration testing"
        - "Docker containerization"

  repository_hygiene:
    description: "Lean Core Rules â€” SDK manages shared code"
    deleted_paths:
      - path: "src/Shared/Throw/"
        reason: "Replaced by SDK injection (Microsoft.Shared.Diagnostics)"
        managed_by: "ANcpLua.NET.Sdk (InjectSharedThrow=true)"

      - path: "src/LegacySupport/"
        reason: "Replaced by SDK polyfills"
        managed_by: "ANcpLua.NET.Sdk (InjectXxxOnLegacy properties)"

      - path: "eng/analyzers/defaults/"
        reason: "Replaced by SDK props"
        managed_by: "ANcpLua.NET.Sdk (IncludeDefaultBannedSymbols=true)"

      - path: "sdk/"
        reason: "Local SDK folder removed"
        managed_by: "NuGet reference to ANcpLua.NET.Sdk"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# SDK INTEGRATION
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

sdk_integration:
  package: "ANcpLua.NET.Sdk"
  version: "1.1.8"
  nuget_urls:
    - "https://www.nuget.org/packages/ANcpLua.NET.Sdk/1.1.8"
    - "https://www.nuget.org/packages/ANcpLua.NET.Sdk.Web/1.1.8"

  global_json: |
    {
      "sdk": { "version": "10.0.100" },
      "msbuild-sdks": {
        "ANcpLua.NET.Sdk": "1.1.8",
        "ANcpLua.NET.Sdk.Web": "1.1.8"
      }
    }

  provides:
    - "Throw.cs guard clauses (Microsoft.Shared.Diagnostics)"
    - "BannedApiAnalyzers (RS0030)"
    - "Polyfills for legacy TFMs"
    - "Standard analyzer configurations"
    - "CLAUDE.md auto-generation"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# HIGH-LEVEL ARCHITECTURE
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

architecture:
  diagram: |
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       OTLP (HTTP/gRPC)      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  User App (SDK)   â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚      qyl.collector       â”‚
    â”‚  (OpenTelemetry)  â”‚                             â”‚  (.NET 10 Minimal API)   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                             â”‚  [Ingestion â†’ DuckDB]    â”‚
                                                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        HTTP (REST)                        â”‚
    â”‚      qyl.mcp      â”‚ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚   (MCP Server)    â”‚                                           â”‚ REST + SSE
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â–²                                       â”‚      qyl.dashboard       â”‚
              â”‚ stdio                                 â”‚    (React 19 + Vite 6)   â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚  AI Agent (User)  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  communication_rules:
    - scope: "qyl.mcp â†’ qyl.collector"
      protocol: "HTTP ONLY"
      constraint: "NO ProjectReference allowed. Decoupled via REST API."
      resilience: "StandardResilienceHandler (Polly) required."

    - scope: "qyl.dashboard â†’ qyl.collector"
      protocol: "HTTP (REST) + SSE (Streaming)"
      constraint: "Frontend uses Kiota-generated clients. SSE triggers Query Invalidation."

    - scope: "qyl.collector â†’ DuckDB"
      protocol: "In-Process (DuckDB.NET.Data.Full)"
      constraint: "Single Writer (System.Threading.Lock), Multiple Readers."

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# PROJECT STRUCTURE (from COMPLETE_STRUCTURE.txt)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

projects:
  count: 4  # FIXED â€” No additional projects allowed

  qyl.protocol:
    path: "src/qyl.protocol"
    type: "class_library"
    sdk: "ANcpLua.NET.Sdk"
    purpose: "Shared types between all qyl components â€” LEAF project"
    publish: "NuGet"
    target_frameworks: [ "net10.0", "net8.0", "netstandard2.0" ]
    dependencies:
      allowed: [ "System.*", "Microsoft.Extensions.Primitives" ]
      forbidden: [ "qyl.*", "DuckDB.*", "OpenTelemetry.*", "Grpc.*" ]
    structure:
      Primitives:
        - "SessionId.cs"      # readonly record struct SessionId(Guid)
        - "UnixNano.cs"       # readonly record struct UnixNano(ulong)
      Models:
        - "SpanRecord.cs"     # Flattened span for DuckDB
        - "GenAiSpanData.cs"  # Extracted gen_ai.* attributes
        - "SessionSummary.cs" # Aggregated session
        - "TraceNode.cs"      # Hierarchical trace tree
      Attributes:
        - "GenAiAttributes.cs"  # OTel 1.38 gen_ai.* constants
      Contracts:
        - "ISpanStore.cs"           # Storage abstraction
        - "ISessionAggregator.cs"   # Aggregation abstraction

  qyl.collector:
    path: "src/qyl.collector"
    type: "web_api"
    sdk: "ANcpLua.NET.Sdk.Web"
    purpose: "Backend â€” OTLP receiver, DuckDB storage, REST/SSE API"
    publish: "Docker (ghcr.io/qyl/collector)"
    framework: "ASP.NET Core Minimal APIs"
    ports:
      http_api: 8080
      otlp_http: 4318
      otlp_grpc: 4317
    dependencies:
      allowed: [ "qyl.protocol", "DuckDB.NET.Data.Full@1.4.3", "Google.Protobuf", "Grpc.AspNetCore" ]
      forbidden: [ "qyl.mcp", "qyl.dashboard", "OpenTelemetry.Exporter.*" ]
    structure:
      Ingestion:
        - "OtlpJsonSpanParser.cs"   # Zero-allocation JSON parser
        - "OtlpAttributes.cs"       # OTLP attribute constants
        - "OtlpTypes.cs"            # OTLP DTOs
        - "SchemaNormalizer.cs"     # Migrate deprecated attrs to 1.38
      Storage:
        - "DuckDbStore.cs"    # ISpanStore impl (Lock class)
        - "DuckDbSchema.cs"   # DDL + migrations (SINGLE SOURCE)
        - "SpanRecord.cs"     # Span data model
        - "SpanBatch.cs"      # Batch insert model
        - "GenAiStats.cs"     # GenAI statistics
        - "StorageStats.cs"   # Storage statistics
      Query:
        - "SessionQueryService.cs"  # Session aggregation queries
      Realtime:
        - "SseEndpoints.cs"         # TypedResults.ServerSentEvents()
        - "SseHub.cs"               # Channel-based pub/sub
        - "TelemetrySseStream.cs"   # SSE stream formatting
      Pipeline:
        - "SpanIngestionPipeline.cs"  # Channel<T> backpressure
      Extensions:
        - "ActivityExtensions.cs"   # Activity extension members
      Parsing:
        - "TraceContextParser.cs"   # W3C traceparent parser
      Primitives:
        - "TraceId.cs"    # IUtf8SpanParsable<TraceId>
        - "SpanId.cs"     # IUtf8SpanParsable<SpanId>
        - "UnixNano.cs"   # Unix timestamp nanoseconds
        - "SessionId.cs"  # Session identifier
      Auth:
        - "TokenAuth.cs"      # Token authentication
        - "TokenGenerator.cs" # Token generation
      Models:
        - "ParsedSpan.cs"   # Parsed span representation
      root:
        - "Program.cs"              # Entry point, DI, endpoints
        - "GenAiAttributes.cs"      # OTel 1.38 gen_ai.* constants
        - "GenAiProviders.cs"       # Provider detection from host
        - "GenAiExtractor.cs"       # Extract gen_ai.* attributes
        - "QylSerializerContext.cs" # AOT JsonSerializerContext

  qyl.mcp:
    path: "src/qyl.mcp"
    type: "console_app"
    sdk: "ANcpLua.NET.Sdk"
    purpose: "MCP Server â€” HTTP client to collector, NO direct DB access"
    publish: "Docker (ghcr.io/qyl/mcp)"
    framework: ".NET Generic Host + MCP SDK"
    transport: "stdio"
    dependencies:
      allowed: [ "qyl.protocol", "ModelContextProtocol", "System.Net.Http" ]
      forbidden: [ "qyl.collector", "qyl.dashboard", "DuckDB.*" ]
    communication:
      to_collector: "HTTP_ONLY"  # CRITICAL: No ProjectReference!
    structure:
      Client:
        - "QylCollectorClient.cs"   # Typed HttpClient to collector
      Tools:
        - "QuerySpansTool.cs"       # [McpTool("query_spans")]
        - "GetSessionTool.cs"       # [McpTool("get_session")]
        - "GetTraceTool.cs"         # [McpTool("get_trace")]
        - "AnalyzeGenAiTool.cs"     # [McpTool("analyze_genai")]
        - "ListServicesTool.cs"     # [McpTool("list_services")]
        - "CompareSessionsTool.cs"  # [McpTool("compare_sessions")]

  qyl.dashboard:
    path: "src/qyl.dashboard"
    type: "spa"
    sdk: "esproj"  # VS JavaScript project integration
    purpose: "React frontend â€” separate deployable, HTTP to collector"
    publish: "Docker (ghcr.io/qyl/dashboard)"
    framework: "React 19 + Vite 6 + Tailwind 4 + TanStack Query 5"
    dependencies:
      allowed: [ "react", "react-dom", "@tanstack/react-query", "recharts", "tailwindcss" ]
      forbidden: [ "ANY .NET project" ]
    communication:
      to_collector: "HTTP_ONLY"  # REST + SSE
    structure:
      src:
        api:
          - "client.ts"   # Fetch wrapper
          - "hooks.ts"    # useSessions, useSpans, useTrace
        hooks:
          - "useSse.ts"   # useSpanStream() SSE hook
        components:
          layout: [ "Sidebar.tsx", "Header.tsx" ]
          sessions: [ "SessionList.tsx", "SessionCard.tsx" ]
          traces: [ "TraceTree.tsx", "SpanDetail.tsx" ]
          genai: [ "TokenChart.tsx", "ModelUsage.tsx", "CostBreakdown.tsx" ]
        pages:
          - "SessionsPage.tsx"
          - "TracesPage.tsx"
          - "GenAiPage.tsx"
          - "SettingsPage.tsx"
        types:
          - "index.ts"
          - "api.ts"  # Manual types (deprecated)
          generated: "Kiota output (DO NOT EDIT)"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# DEPENDENCY GRAPH (ENFORCE STRICTLY)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

dependency_rules:
  graph: |
    qyl.dashboard â”€â”€HTTPâ”€â”€â–º qyl.collector â—„â”€â”€HTTPâ”€â”€ qyl.mcp
                                 â”‚
                                 â–¼
                           qyl.protocol

  rules:
    - from: "qyl.protocol"
      to: [ ]
      note: "LEAF project â€” BCL only"

    - from: "qyl.collector"
      to: [ "qyl.protocol" ]
      forbidden: [ "qyl.mcp", "qyl.dashboard" ]

    - from: "qyl.mcp"
      to: [ "qyl.protocol" ]
      forbidden: [ "qyl.collector", "qyl.dashboard" ]
      note: "HTTP to collector, NO ProjectReference"

    - from: "qyl.dashboard"
      to: [ ]
      forbidden: [ "*.csproj" ]
      note: "Pure frontend, HTTP only"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# TYPESPEC SOURCE OF TRUTH (core/specs/)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

typespec:
  purpose: "Contract-first API and schema definitions"
  entry_point: "core/specs/main.tsp"

  structure:
    specs:
      - "main.tsp"              # Entry point
      - "tspconfig.yaml"        # TypeSpec compiler config
      - "package.json"          # TypeSpec + emitter deps
      api:
        - "main.tsp"            # @route("/api/v1")
        - "sessions.tsp"        # Sessions endpoints
        - "traces.tsp"          # Traces endpoints
        - "spans.tsp"           # Spans endpoints
        - "metrics.tsp"         # Metrics endpoints
        - "streaming.tsp"       # SSE endpoints
      models:
        - "primitives.tsp"      # SessionId, UnixNano
        - "spans.tsp"           # SpanRecord, SpanData
        - "sessions.tsp"        # SessionSummary
        - "traces.tsp"          # TraceNode
        - "genai.tsp"           # GenAiSpanData (OTel 1.38)
        - "errors.tsp"          # ErrorResponse
      storage:
        - "decorators.tsp"      # @table, @column, @index, @promoted
        - "tables.tsp"          # spans table definition
      otel:
        - "semconv.tsp"         # gen_ai.* attributes (v1.38)
        - "resource.tsp"        # service.name, etc.

    emitters:
      duckdb:
        package: "@qyl/typespec-duckdb"
        outputs:
          - "schema.sql"          # CREATE TABLE statements
          - "DuckDbSchema.g.cs"   # FrozenDictionary mappings
      csharp_models:
        package: "@qyl/typespec-csharp-models"
        outputs:
          - "Models.g.cs"         # C# record types

    generated:
      openapi:
        - "openapi.yaml"        # Generated by @typespec/openapi3
      duckdb:
        - "schema.sql"          # Generated by @qyl/typespec-duckdb
        - "DuckDbSchema.g.cs"   # FrozenDictionary mappings
      csharp:
        - "Models.g.cs"         # Generated by @qyl/typespec-csharp-models

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# MANDATORY CODING PATTERNS (.NET 10 / C# 14)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

patterns:
  concurrency:
    - rule: "Use System.Threading.Lock for SYNC code"
      bad: "private readonly object _lock = new();"
      good: "private readonly Lock _lock = new();"
      why: ".NET 9+ primitive, cleaner and strictly typed."
      example: |
        using (_lock.EnterScope())
        {
            // thread-safe code (SYNC only!)
        }

    - rule: "Use SemaphoreSlim(1,1) for ASYNC code"
      why: "Lock.EnterScope() returns ref struct - cannot cross await boundaries"
      example: |
        private readonly SemaphoreSlim _asyncLock = new(1, 1);

        await _asyncLock.WaitAsync(ct);
        try
        {
            await SomeAsyncOperation(ct);
        }
        finally
        {
            _asyncLock.Release();
        }

  collections:
    - rule: "Use Collection Expressions"
      bad: "new List<string>()"
      good: "List<string> list = [];"

    - rule: "Use FrozenDictionary for Lookups"
      good: "static readonly FrozenDictionary<K,V> Map = dict.ToFrozenDictionary();"
      why: "Immutable, optimized for reads"

    - rule: "Use FrozenSet for Membership"
      good: "static readonly FrozenSet<string> Allowed = values.ToFrozenSet();"

    - rule: "Use CountBy / AggregateBy"
      bad: ".GroupBy().ToDictionary()"
      good: ".CountBy(x => x.Key)"

  time_handling:
    - rule: "Use TimeProvider"
      bad: "DateTime.UtcNow"
      good: "TimeProvider.System.GetUtcNow()"
      why: "Testability (FakeTimeProvider)."

  async_patterns:
    - rule: "ValueTask for hot paths"
      example: "public ValueTask PublishAsync(SpanRecord span) => _channel.Writer.WriteAsync(span);"
      why: "Reduced allocations in hot paths"

    - rule: "IAsyncEnumerable for streaming"
      example: "public async IAsyncEnumerable<T> StreamAsync([EnumeratorCancellation] CancellationToken ct)"
      why: "Memory-efficient streaming"

    - rule: "await using for async disposal"
      example: "await using var connection = await factory.CreateAsync();"
      why: "Proper async disposal"

  web_api:
    - rule: "TypedResults.ServerSentEvents (NET 10)"
      example: "return TypedResults.ServerSentEvents(stream, eventType: \"span\");"
      context: "For SSE endpoints in qyl.collector"

    - rule: "Strict JSON Serialization"
      good: "JsonSerializerOptions.Strict"

  observability:
    - rule: "Source Generated Logging"
      good: "[LoggerMessage] partial void Log(...)"

    - rule: "Compliance Redaction"
      good: "Use [LogProperties] with QylDataClasses taxonomy"

  channels:
    - rule: "Bounded Channels for backpressure"
      example: |
        Channel.CreateBounded<SpanRecord>(new BoundedChannelOptions(10_000)
        {
            FullMode = BoundedChannelFullMode.Wait
        });

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# STORAGE RULES (DuckDB 1.4.3)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

storage:
  engine: "DuckDB.NET.Data.Full"
  version: "1.4.3"
  nuget_url: "https://www.nuget.org/packages/DuckDB.NET.Data.Full/1.4.3"
  github_url: "https://github.com/Giorgi/DuckDB.NET"

  critical_rules:
    - name: "Infinity Date Handling"
      description: "DuckDB 1.4.3 returns Â±Infinity for dates. Must check .IsInfinity."
      code_pattern: |
        var date = reader.GetFieldValue<DuckDBDateOnly>(i);
        if (date.IsInfinity || date.IsPositiveInfinity || date.IsNegativeInfinity)
        {
            // Handle infinite date - cannot convert to DateTime/DateOnly
        }
        else
        {
            DateOnly netDate = date; // Safe conversion
        }

    - name: "Transaction Safety"
      description: "Use improved transaction abortion handling in 1.4.3."

    - name: "Single Writer Pattern"
      description: "Use System.Threading.Lock for write operations."
      code_pattern: |
        private readonly Lock _lock = new();

        using (_lock.EnterScope())
        {
            using var appender = _connection.CreateAppender("spans");
            // bulk insert
        }

    - name: "Single Source of Truth"
      description: "Table definitions MUST match core/specs/storage/tables.tsp."

  package_variants:
    - name: "DuckDB.NET.Data"
      native_dlls: false
      use_case: "ADO.NET only (BYOD)"

    - name: "DuckDB.NET.Data.Full"
      native_dlls: true
      use_case: "ADO.NET + bundled DuckDB (RECOMMENDED)"

    - name: "DuckDB.NET.Bindings"
      native_dlls: false
      use_case: "Low-level P/Invoke"

    - name: "DuckDB.NET.Bindings.Full"
      native_dlls: true
      use_case: "P/Invoke + bundled DuckDB"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# OTEL SEMANTIC CONVENTIONS v1.38
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

otel_semconv:
  version: "1.38.0"

  gen_ai_attributes:
    current:
      - key: "gen_ai.operation.name"
        type: "string"
        values: [ "chat", "text_completion", "embeddings", "image_generation" ]

      - key: "gen_ai.provider.name"
        type: "string"
        values: [ "anthropic", "openai", "google", "azure", "cohere", "mistral" ]
        note: "Replaces deprecated gen_ai.system"

      - key: "gen_ai.request.model"
        type: "string"
        example: "gpt-4o"

      - key: "gen_ai.response.model"
        type: "string"
        example: "gpt-4o-2024-08-06"

      - key: "gen_ai.usage.input_tokens"
        type: "int"
        note: "Replaces deprecated gen_ai.usage.prompt_tokens"

      - key: "gen_ai.usage.output_tokens"
        type: "int"
        note: "Replaces deprecated gen_ai.usage.completion_tokens"

  migrations:
    - from: "gen_ai.system"
      to: "gen_ai.provider.name"

    - from: "gen_ai.usage.prompt_tokens"
      to: "gen_ai.usage.input_tokens"

    - from: "gen_ai.usage.completion_tokens"
      to: "gen_ai.usage.output_tokens"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# FRONTEND STANDARDS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

frontend:
  stack:
    react: "19.2.0"
    vite: "6.0.0"
    typescript: "5.7"
    tailwind: "4.1.17"
    tanstack_query: "5.90.11"
    tanstack_virtual: "3.x"
    react_router: "7.x"
    recharts: "2.x"

  conventions:
    - "Hooks only, no forwardRef (React 19)"
    - "Use cn() helper for Tailwind classes"
    - "Use Kiota-generated clients (src/types/generated)"
    - "Use telemetryKeys factory for Query Keys"
    - "SSE triggers Query Invalidation"

  sse_pattern: |
    export function useSpanStream() {
      const queryClient = useQueryClient();

      useEffect(() => {
        const es = new EventSource('/api/v1/events/spans');

        es.onmessage = (event) => {
          queryClient.invalidateQueries({ queryKey: ['sessions'] });
          queryClient.invalidateQueries({ queryKey: ['spans'] });
        };

        es.onerror = () => {
          es.close();
          setTimeout(() => new EventSource('/api/v1/events/spans'), 3000);
        };

        return () => es.close();
      }, [queryClient]);
    }

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# COMPLIANCE TAXONOMY
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

compliance:
  implementation: "Microsoft.Extensions.Compliance.Redaction"

  data_classes:
    - class: "qyl.secret"
      action: "ERASE"
      examples: [ "Tokens", "API Keys", "Passwords" ]

    - class: "qyl.pii"
      action: "HMAC"
      examples: [ "Emails", "Phone Numbers", "Names" ]

    - class: "qyl.id.user"
      action: "HMAC"
      note: "User IDs â€” correlation allowed"

    - class: "qyl.id.tenant"
      action: "HMAC"
      note: "Tenant IDs â€” correlation allowed"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# SINGLE SOURCE OF TRUTH RULES
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

single_source_rules:
  - resource: "DuckDB Schema"
    source: "qyl.collector/Storage/DuckDbSchema.cs"
    rule: "ALL table definitions MUST be in this file only"

  - resource: "Session Aggregation"
    source: "qyl.collector/Query/SessionQueryService.cs"
    rule: "ALL aggregation logic MUST use SQL queries in this file"

  - resource: "OTel Attribute Constants"
    source: "qyl.protocol/Attributes/GenAiAttributes.cs"
    rule: "ALL gen_ai.* string constants defined here"

  - resource: "TypeScript API Types"
    source: "qyl.dashboard/src/types/generated/"
    rule: "Generated by Kiota â€” DO NOT edit manually"

  - resource: "TypeSpec Contracts"
    source: "core/specs/"
    rule: "API and schema definitions â€” generates all other contracts"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# BANNED APIS (via RS0030)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

banned_apis:
  threading:
    - pattern: "Monitor.Enter/Exit/TryEnter"
      use_instead: "Lock.EnterScope()"
      reason: ".NET 9+ Lock class is type-safe"

  datetime:
    - pattern: "DateTime.Now"
      use_instead: "TimeProvider.System.GetLocalNow()"

    - pattern: "DateTime.UtcNow"
      use_instead: "TimeProvider.System.GetUtcNow()"

    - pattern: "DateTime.Today"
      use_instead: "TimeProvider.System.GetLocalNow().Date"

  task_delay:
    - pattern: "Task.Delay(int/TimeSpan)"
      use_instead: "TimeProvider.Delay()"

  json:
    - pattern: "Newtonsoft.Json.*"
      use_instead: "System.Text.Json"
      reason: "BCL JSON is faster and AOT-compatible"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# NUKE BUILD TARGETS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

build_system:
  tool: "NUKE"
  entry: "eng/build/Build.cs"

  targets:
    - name: "Clean"
      description: "Clean all outputs"

    - name: "Restore"
      description: "NuGet + npm restore"

    - name: "Compile"
      description: "Build all projects"

    - name: "Test"
      description: "Run all tests"

    - name: "Pack"
      description: "Create NuGet packages"

    - name: "TypeSpec"
      description: "Compile TypeSpec specs"
      subtargets:
        - "TypeSpecCompile: tsp compile core/specs/"
        - "TypeSpecEmit: Run custom emitters"

    - name: "Kiota"
      description: "Generate TypeScript client"
      subtargets:
        - "KiotaGenerate: kiota generate -l typescript"

    - name: "Docker"
      description: "Build Docker images"
      subtargets:
        - "DockerCollector: ghcr.io/qyl/collector"
        - "DockerMcp: ghcr.io/qyl/mcp"
        - "DockerDashboard: ghcr.io/qyl/dashboard"

    - name: "Publish"
      description: "Publish to NuGet/GHCR"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# REJECTED ALTERNATIVES
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

rejected:
  - idea: "ZLinq for qyl"
    reason: "Wrong bottleneck â€” DuckDB I/O is the limit, not LINQ overhead"

  - idea: "Separate SDK variants (ANcpLua.NET.Sdk.Web, .Test)"
    reason: "Layering pattern with auto-detection is simpler and covers all cases"

  - idea: "Custom TraceId/SpanId structs"
    reason: "BCL ActivityTraceId/ActivitySpanId are sufficient and standard"

  - idea: "Qyl.Sdk NuGet for user applications"
    reason: "Users should use standard OpenTelemetry â€” qyl is a backend, not a client SDK"

  - idea: "qyl.telemetry as separate project"
    reason: "Redundant â€” content merged into qyl.protocol"

  - idea: "TypeSpec for C# primitives"
    reason: "C#-specific patterns (ISpanParsable, UInt128) cannot be expressed in TypeSpec"

  - idea: "Full TypeSpec code generation"
    reason: "Overkill for 4 projects â€” hybrid approach is better"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# VERTICAL SLICE ARCHITECTURE
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Features are implemented end-to-end through all layers in one pass.
# See: docs/architecture/decisions/ for detailed ADRs.

vertical_slices:
  pattern: |
    TypeSpec â†’ Storage â†’ Query â†’ API â†’ MCP â†’ Dashboard
                    One Feature, Complete

  registry:
    - id: VS-01
      name: "Span Ingestion"
      adr: "docs/architecture/decisions/0002-vs01-span-ingestion.md"
      priority: P0
      depends_on: [ ]
      status: PARTIAL
      completed: [ "DuckDbStore.cs", "SpanRecord.cs", "OtlpJsonSpanParser.cs" ]
      remaining: [ "Integration tests", "OTLP gRPC endpoint" ]

    - id: VS-02
      name: "List Sessions"
      adr: "docs/architecture/decisions/0003-vs02-list-sessions.md"
      priority: P0
      depends_on: [ VS-01 ]
      status: IN_PROGRESS
      current: "SessionQueryService.cs OTel 1.38 migration"

    - id: VS-03
      name: "View Trace Tree"
      adr: "docs/architecture/decisions/0004-vs03-view-trace-tree.md"
      priority: P1
      depends_on: [ VS-01 ]
      status: NOT_STARTED

    - id: VS-04
      name: "GenAI Analytics"
      adr: "docs/architecture/decisions/0005-vs04-genai-analytics.md"
      priority: P1
      depends_on: [ VS-01, VS-02 ]
      status: NOT_STARTED

    - id: VS-05
      name: "Live Streaming"
      adr: "docs/architecture/decisions/0006-vs05-live-streaming.md"
      priority: P2
      depends_on: [ VS-01 ]
      status: PARTIAL
      completed: [ "SseHub.cs", "SseEndpoints.cs" ]
      remaining: [ "Dashboard integration" ]

    - id: VS-06
      name: "MCP Query Tool"
      adr: "docs/architecture/decisions/0007-vs06-mcp-query-tool.md"
      priority: P2
      depends_on: [ VS-01, VS-02 ]
      status: NOT_STARTED

  dependency_graph: |
    VS-01 â”€â”€â–º VS-02 â”€â”€â–º VS-04
      â”‚         â””â”€â”€â”€â”€â–º VS-06
      â”œâ”€â”€â–º VS-03
      â””â”€â”€â–º VS-05

  implementation_order:
    - phase: "P0 (Foundation)"
      slices: [ VS-01, VS-02 ]
      goal: "Core ingestion + session listing"

    - phase: "P1 (Core Features)"
      slices: [ VS-03, VS-04 ]
      goal: "Trace visualization + GenAI analytics"

    - phase: "P2 (Enhancement)"
      slices: [ VS-05, VS-06 ]
      goal: "Real-time streaming + AI agent tooling"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# AI CONTEXT USAGE
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ai_context:
  usage: |
    Any AI Agent operating in this repository MUST treat this file
    as the overriding authority for Architecture, Patterns, and Structure.

    Sub-project CLAUDE.md files inherit from the root CLAUDE.md,
    which in turn references this specification.

  related_docs:
    - path: "CLAUDE.md"
      purpose: "Root AI context (inherited by all projects)"

    - path: "docs/MIGRATION_MASTER.yaml"
      purpose: "Build repair + execution tasks"

    - path: "docs/architecture/decisions/"
      purpose: "Vertical Slice ADRs (feature implementation)"

  claude_md_hierarchy:
    root: "/CLAUDE.md"
    projects:
      - "/src/qyl.protocol/CLAUDE.md â†’ @../../CLAUDE.md"
      - "/src/qyl.collector/CLAUDE.md â†’ @../../CLAUDE.md"
      - "/src/qyl.mcp/CLAUDE.md â†’ @../../CLAUDE.md"
      - "/src/qyl.dashboard/CLAUDE.md â†’ @../../CLAUDE.md"
