# OTel Semantic Conventions Generator

## Mission

Build ONE generator that produces OTel Semantic Conventions for Frontend, Backend, and DB from a single source.

## Architecture

```
@opentelemetry/semantic-conventions (NPM v1.39.0)
                    │
                    ▼
    ┌───────────────────────────────┐
    │   generate-semconv.ts         │
    │   (TypeScript, runs in SDK)   │
    └───────────────────────────────┘
                    │
        ┌───────────┼───────────┐
        ▼           ▼           ▼
   TypeScript      C#        DuckDB
   constants    constants   columns
```

## Location

```
ANcpLua.NET.Sdk/
└── tools/
    └── SemconvGenerator/
        ├── package.json
        ├── generate-semconv.ts    ← THE generator
        └── tsconfig.json
```

## Input

NPM package: `@opentelemetry/semantic-conventions@1.39.0`

The package exports:
- `ATTR_*` constants (attribute names)
- `*_VALUE_*` constants (enum values)

Example from `.d.ts`:
```typescript
export declare const ATTR_GEN_AI_SYSTEM: "gen_ai.system";
export declare const GEN_AI_SYSTEM_VALUE_OPENAI: "openai";
export declare const GEN_AI_SYSTEM_VALUE_ANTHROPIC: "anthropic";
```

## Outputs

### 1. TypeScript (`semconv.ts`)

```typescript
// Generated from @opentelemetry/semantic-conventions v1.39.0

export const GEN_AI_SYSTEM = "gen_ai.system" as const;
export const GEN_AI_REQUEST_MODEL = "gen_ai.request.model" as const;

export const GenAiSystemValues = {
  OPENAI: "openai",
  ANTHROPIC: "anthropic",
  AWS_BEDROCK: "aws.bedrock",
} as const;
```

**Target:** `qyl/src/qyl.dashboard/src/lib/semconv.ts`

### 2. C# (`SemanticConventions.g.cs`)

```csharp
// <auto-generated/>
// Generated from @opentelemetry/semantic-conventions v1.39.0

namespace ANcpSdk.Instrumentation;

public static class GenAiAttributes
{
    public const string System = "gen_ai.system";
    public const string RequestModel = "gen_ai.request.model";
}

public static class GenAiSystemValues
{
    public const string OpenAi = "openai";
    public const string Anthropic = "anthropic";
    public const string AwsBedrock = "aws.bedrock";
}
```

**Target:** `ANcpLua.NET.Sdk/eng/ANcpSdk.AspNetCore.ServiceDefaults/Instrumentation/SemanticConventions.g.cs`

### 3. DuckDB Columns (`promoted-columns.sql`)

```sql
-- Generated from @opentelemetry/semantic-conventions v1.39.0
-- Promoted columns for fast queries (extracted from attributes_json)

-- GenAI attributes
gen_ai_system VARCHAR,
gen_ai_request_model VARCHAR,
gen_ai_response_model VARCHAR,
gen_ai_input_tokens BIGINT,
gen_ai_output_tokens BIGINT,
```

**Target:** Consumed by `SchemaGenerator.cs` when generating DuckDB schema

## Generator Implementation

```typescript
#!/usr/bin/env npx tsx

import * as fs from 'fs';
import * as path from 'path';

const SEMCONV_PATH = path.join(__dirname, 'node_modules/@opentelemetry/semantic-conventions/build/src');

interface Attribute {
  name: string;      // ATTR_GEN_AI_SYSTEM
  value: string;     // "gen_ai.system"
}

interface EnumValue {
  attribute: string; // GEN_AI_SYSTEM
  name: string;      // OPENAI
  value: string;     // "openai"
}

function parse(): { attributes: Attribute[], enums: EnumValue[] } {
  // Parse experimental_attributes.d.ts
  // Extract ATTR_* and *_VALUE_* declarations
}

function generateTypeScript(data): string {
  // Generate semconv.ts
}

function generateCSharp(data): string {
  // Generate SemanticConventions.g.cs
}

function generateDuckDb(data): string {
  // Generate promoted-columns.sql
}

// Main
const data = parse();
fs.writeFileSync('output/semconv.ts', generateTypeScript(data));
fs.writeFileSync('output/SemanticConventions.g.cs', generateCSharp(data));
fs.writeFileSync('output/promoted-columns.sql', generateDuckDb(data));
```

## package.json

```json
{
  "name": "@ancplua/semconv-generator",
  "scripts": {
    "generate": "tsx generate-semconv.ts",
    "generate:ts": "tsx generate-semconv.ts --ts-only",
    "generate:cs": "tsx generate-semconv.ts --cs-only",
    "generate:sql": "tsx generate-semconv.ts --sql-only"
  },
  "devDependencies": {
    "@opentelemetry/semantic-conventions": "1.39.0",
    "tsx": "^4.21.0",
    "typescript": "^5.9.0"
  }
}
```

## Workflow

```bash
# Initial setup
cd ANcpLua.NET.Sdk/tools/SemconvGenerator
npm install

# Generate all outputs
npm run generate

# Update OTel version
npm install @opentelemetry/semantic-conventions@1.40.0
npm run generate
git commit -am "chore: update OTel semconv to 1.40.0"
```

## Scope

**Include (GenAI focus for now):**
- `gen_ai.*` attributes
- `gen_ai.*` enum values

**Exclude (add later if needed):**
- `http.*`, `db.*`, `rpc.*` etc.
- Can be extended by adding more patterns to parser

## Acceptance Criteria

1. [ ] Generator parses NPM package correctly
2. [ ] TypeScript output compiles without errors
3. [ ] C# output compiles without errors
4. [ ] DuckDB columns match existing schema
5. [ ] All three outputs are consistent (same attributes)
6. [ ] Running `npm run generate` twice produces identical output
7. [ ] Generator handles deprecated attributes with `@deprecated` JSDoc

## Cleanup After Implementation

1. Delete `qyl/core/specs/domains/` (13,400 lines of TypeSpec OTel copies)
2. Delete `qyl/core/specs/generate-csharp.ts` (old generator attempt)
3. Delete manual `SemanticConventions.cs` in SDK
4. Update `qyl/core/specs/main.tsp` to remove domain imports
