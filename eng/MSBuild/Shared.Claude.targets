<Project>
  <!-- =======================================================================
       CLAUDE.md Generation System - Targets
       Import this in Directory.Build.targets
       
       Generates rich YAML-format CLAUDE.md files from csproj metadata.
       Supports hybrid mode: generated sections + custom sections preserved.
       ======================================================================= -->

  <PropertyGroup>
    <!-- Re-evaluate path based on ClaudeMdLocation (props evaluation order issue) -->
    <_ClaudeMdPath Condition="'$(ClaudeMdLocation)' == 'dotclaude'">$(MSBuildProjectDirectory)/.claude/CLAUDE.md</_ClaudeMdPath>
    <_ClaudeMdPath Condition="'$(_ClaudeMdPath)' == ''">$(MSBuildProjectDirectory)/CLAUDE.md</_ClaudeMdPath>
    <_RootClaudeMd>$([MSBuild]::GetPathOfFileAbove('CLAUDE.md', '$(MSBuildProjectDirectory)/..'))</_RootClaudeMd>
    <!-- Note: GetPathOfFileAbove only accepts filenames, not paths with directories -->
    <!-- .claude/CLAUDE.md lookup skipped - use standard CLAUDE.md location -->
    <_ClaudeMdMarker>&lt;!-- AUTO-GENERATED BY MSBUILD - DO NOT EDIT ABOVE THIS LINE --&gt;</_ClaudeMdMarker>
    <_ClaudeMdCustomMarker>&lt;!-- CUSTOM CONTENT BELOW - EDIT FREELY --&gt;</_ClaudeMdCustomMarker>
  </PropertyGroup>

  <!-- =======================================================================
       ItemGroups for structured data
       ======================================================================= -->
  
  <!-- 
    ClaudeEndpoint: API endpoints this project exposes
    Example:
    <ClaudeEndpoint Include="/api/v1/sessions" Method="GET" Returns="SessionSummary[]" Protocol="rest"/>
    <ClaudeEndpoint Include="/v1/traces" Method="POST" Protocol="otlp-http"/>
    <ClaudeEndpoint Include="4317" Protocol="otlp-grpc" Service="TraceService"/>
  -->
  
  <!--
    ClaudePort: Network ports
    Example:
    <ClaudePort Include="5100" Env="QYL_PORT" Serves="rest-api;sse;static-files"/>
    <ClaudePort Include="4317" Env="QYL_GRPC_PORT" Serves="otlp-grpc"/>
  -->
  
  <!--
    ClaudeGeneratedFile: Files generated by build, never edit manually
    Example:
    <ClaudeGeneratedFile Include="Storage/DuckDbSchema.g.cs" Generator="nuke Generate"/>
    <ClaudeGeneratedFile Include="**/*.g.cs" Generator="SchemaGenerator"/>
  -->
  
  <!--
    ClaudeDependency: Key dependencies with purpose
    Example:
    <ClaudeDependency Include="qyl.protocol" Type="project" Purpose="shared types"/>
    <ClaudeDependency Include="DuckDB.NET.Data.Full" Type="package" Purpose="storage engine"/>
  -->
  
  <!--
    ClaudeForbidden: Things explicitly NOT allowed
    Example:
    <ClaudeForbidden Include="qyl.dashboard" Reason="build artifact, not dependency"/>
    <ClaudeForbidden Include="throw new Exception" Reason="use Throw.If* instead" Severity="error"/>
  -->
  
  <!--
    ClaudePattern: Required patterns/conventions
    Example:
    <ClaudePattern Include="Channel&lt;T&gt;" Context="async-buffer" Capacity="10000"/>
    <ClaudePattern Include="TimeProvider.System" Context="time-abstraction"/>
  -->
  
  <!--
    ClaudeEnvVar: Environment variables
    Example:
    <ClaudeEnvVar Include="QYL_PORT" Default="5100" Type="int"/>
    <ClaudeEnvVar Include="QYL_DATA_PATH" Default="/data/qyl.duckdb" Type="string"/>
  -->

  <!-- =======================================================================
       Inline task for intelligent file writing (preserves custom content)
       ======================================================================= -->
  <UsingTask TaskName="_WriteClaudeMd" TaskFactory="RoslynCodeTaskFactory" AssemblyFile="$(MSBuildToolsPath)\Microsoft.Build.Tasks.Core.dll">
    <ParameterGroup>
      <Path ParameterType="System.String" Required="true"/>
      <GeneratedContent ParameterType="System.String" Required="true"/>
      <CustomMarker ParameterType="System.String" Required="true"/>
    </ParameterGroup>
    <Task>
      <Code Type="Fragment" Language="cs">
<![CDATA[
var dir = System.IO.Path.GetDirectoryName(Path);
if (!string.IsNullOrEmpty(dir)) 
    System.IO.Directory.CreateDirectory(dir);

string customContent = "";

// Preserve existing custom content if file exists
if (System.IO.File.Exists(Path))
{
    var existing = System.IO.File.ReadAllText(Path);
    var markerIndex = existing.IndexOf(CustomMarker);
    if (markerIndex >= 0)
    {
        customContent = existing.Substring(markerIndex + CustomMarker.Length);
    }
}

// If no custom content exists, add placeholder
if (string.IsNullOrWhiteSpace(customContent))
{
    customContent = @"

## notes

Add project-specific notes, implementation details, or context here.
This section is preserved across regeneration.
";
}

var finalContent = GeneratedContent + "\n" + CustomMarker + customContent;
System.IO.File.WriteAllText(Path, finalContent);
]]>
      </Code>
    </Task>
  </UsingTask>

  <!-- =======================================================================
       Main Generation Target
       ======================================================================= -->
  <Target Name="_GenerateClaudeMd"
          AfterTargets="Build"
          Condition="'$(GenerateClaudeMd)' == 'true'"
          Inputs="$(MSBuildProjectFile)"
          Outputs="$(_ClaudeMdPath).stamp">

    <!-- Compute relative path to root CLAUDE.md -->
    <PropertyGroup>
      <_RelativeImport Condition="'$(_RootClaudeMd)' != ''">$([MSBuild]::MakeRelative('$(MSBuildProjectDirectory)', '$(_RootClaudeMd)'))</_RelativeImport>
      <!-- %0A is URL-encoded newline - MSBuild preserves this -->
      <_NL>%0A</_NL>
    </PropertyGroup>

    <!-- Build the generated content -->
    <PropertyGroup>
      <!-- Header with @import -->
      <_Content># $(ClaudeName)$(_NL)$(_NL)</_Content>
      <_Content Condition="'$(ClaudePurpose)' != ''">$(_Content)$(ClaudePurpose)$(_NL)$(_NL)</_Content>
      <!-- Official Claude Code import syntax: @path/to/file (no quotes, no "import" keyword) -->
      <_Content Condition="'$(_RelativeImport)' != ''">$(_Content)@$(_RelativeImport)$(_NL)$(_NL)</_Content>
    </PropertyGroup>

    <!-- Identity section -->
    <PropertyGroup>
      <_Content>$(_Content)## identity$(_NL)$(_NL)```yaml$(_NL)</_Content>
      <_Content>$(_Content)name: $(ClaudeName)$(_NL)</_Content>
      <_Content>$(_Content)type: $(ClaudeType)$(_NL)</_Content>
      <_Content>$(_Content)sdk: $(ClaudeSdk)$(_NL)</_Content>
      <_Content>$(_Content)framework: $(TargetFramework)$(_NL)</_Content>
      <_Content Condition="'$(ClaudeRole)' != ''">$(_Content)role: $(ClaudeRole)$(_NL)</_Content>
      <_Content>$(_Content)```$(_NL)</_Content>
    </PropertyGroup>

    <!-- Constraint section (if defined) -->
    <PropertyGroup Condition="'$(ClaudeConstraint)' != ''">
      <_Content>$(_Content)$(_NL)## constraint$(_NL)$(_NL)```yaml$(_NL)</_Content>
      <_Content>$(_Content)type: $(ClaudeConstraint)$(_NL)</_Content>
      <_Content Condition="'$(ClaudeConstraintReason)' != ''">$(_Content)reason: $(ClaudeConstraintReason)$(_NL)</_Content>
      <_Content>$(_Content)```$(_NL)</_Content>
    </PropertyGroup>

    <!-- Ports section -->
    <PropertyGroup Condition="'@(ClaudePort)' != ''">
      <_Content>$(_Content)$(_NL)## ports$(_NL)$(_NL)```yaml$(_NL)</_Content>
    </PropertyGroup>
    <PropertyGroup Condition="'@(ClaudePort)' != ''">
      <_Content>$(_Content)@(ClaudePort->'%(Identity):$(_NL)  env: %(Env)$(_NL)  serves: [%(Serves)]', '$(_NL)')$(_NL)</_Content>
      <_Content>$(_Content)```$(_NL)</_Content>
    </PropertyGroup>

    <!-- Endpoints section -->
    <PropertyGroup Condition="'@(ClaudeEndpoint)' != ''">
      <_Content>$(_Content)$(_NL)## endpoints$(_NL)$(_NL)```yaml$(_NL)</_Content>
      <_Content>$(_Content)@(ClaudeEndpoint->'- path: %(Identity)$(_NL)  method: %(Method)$(_NL)  protocol: %(Protocol)', '$(_NL)$(_NL)')$(_NL)</_Content>
      <_Content>$(_Content)```$(_NL)</_Content>
    </PropertyGroup>

    <!-- Generated files section -->
    <PropertyGroup Condition="'@(ClaudeGeneratedFile)' != ''">
      <_Content>$(_Content)$(_NL)## generated-files$(_NL)$(_NL)```yaml$(_NL)</_Content>
      <_Content>$(_Content)rule: never-edit-manually$(_NL)files:$(_NL)</_Content>
      <_Content>$(_Content)@(ClaudeGeneratedFile->'  - %(Identity)  # %(Generator)', '$(_NL)')$(_NL)</_Content>
      <_Content>$(_Content)```$(_NL)</_Content>
    </PropertyGroup>

    <!-- Dependencies section -->
    <PropertyGroup Condition="'@(ClaudeDependency)' != ''">
      <_Content>$(_Content)$(_NL)## dependencies$(_NL)$(_NL)```yaml$(_NL)</_Content>
      <_Content>$(_Content)@(ClaudeDependency->'- name: %(Identity)$(_NL)  type: %(Type)$(_NL)  purpose: %(Purpose)', '$(_NL)$(_NL)')$(_NL)</_Content>
      <_Content>$(_Content)```$(_NL)</_Content>
    </PropertyGroup>

    <!-- Forbidden section -->
    <PropertyGroup Condition="'@(ClaudeForbidden)' != ''">
      <_Content>$(_Content)$(_NL)## forbidden$(_NL)$(_NL)```yaml$(_NL)</_Content>
      <_Content>$(_Content)@(ClaudeForbidden->'- pattern: %(Identity)$(_NL)  reason: %(Reason)$(_NL)  severity: %(Severity)', '$(_NL)$(_NL)')$(_NL)</_Content>
      <_Content>$(_Content)```$(_NL)</_Content>
    </PropertyGroup>

    <!-- Patterns section -->
    <PropertyGroup Condition="'@(ClaudePattern)' != ''">
      <_Content>$(_Content)$(_NL)## patterns$(_NL)$(_NL)```yaml$(_NL)</_Content>
      <_Content>$(_Content)@(ClaudePattern->'- use: %(Identity)$(_NL)  context: %(Context)', '$(_NL)$(_NL)')$(_NL)</_Content>
      <_Content>$(_Content)```$(_NL)</_Content>
    </PropertyGroup>

    <!-- Environment variables section -->
    <PropertyGroup Condition="'@(ClaudeEnvVar)' != ''">
      <_Content>$(_Content)$(_NL)## environment$(_NL)$(_NL)```yaml$(_NL)</_Content>
      <_Content>$(_Content)@(ClaudeEnvVar->'- name: %(Identity)$(_NL)  default: %(Default)$(_NL)  type: %(Type)', '$(_NL)$(_NL)')$(_NL)</_Content>
      <_Content>$(_Content)```$(_NL)</_Content>
    </PropertyGroup>

    <!-- Add the auto-generated marker -->
    <PropertyGroup>
      <_Content>$(_Content)$(_NL)$(_ClaudeMdMarker)$(_NL)</_Content>
    </PropertyGroup>

    <!-- Write file (preserving custom content) -->
    <_WriteClaudeMd 
      Path="$(_ClaudeMdPath)" 
      GeneratedContent="$(_Content)"
      CustomMarker="$(_ClaudeMdCustomMarker)"/>
    
    <!-- Touch stamp file for incremental builds -->
    <Touch Files="$(_ClaudeMdPath).stamp" AlwaysCreate="true"/>
    
    <Message Importance="high" Text="[Claude] Generated: $(_ClaudeMdPath)"/>
  </Target>

  <!-- =======================================================================
       Clean target
       ======================================================================= -->
  <Target Name="_CleanClaudeMd" AfterTargets="Clean" Condition="'$(GenerateClaudeMd)' == 'true'">
    <Delete Files="$(_ClaudeMdPath).stamp"/>
    <!-- Note: We don't delete CLAUDE.md itself to preserve custom content -->
    <Message Importance="normal" Text="[Claude] Cleaned stamp file (CLAUDE.md preserved)"/>
  </Target>

  <!-- Import modular rules support -->
  <Import Project="$(MSBuildThisFileDirectory)Shared.Claude.Rules.targets" 
          Condition="Exists('$(MSBuildThisFileDirectory)Shared.Claude.Rules.targets')"/>

</Project>
