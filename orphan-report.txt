# qyl Orphan/Stray Pattern Report
Generated: 2026-01-15

═══════════════════════════════════════════════════════════════════════════════
## 1. CLAUDE.md Generation System (Shared.targets) - PARTIALLY ORPHANED
═══════════════════════════════════════════════════════════════════════════════

Location: eng/MSBuild/Shared.targets

### What it was supposed to do:
Auto-generate CLAUDE.md files per project with metadata from csproj properties,
including project info, critical files, anti-patterns, and required patterns.

### Status: INCOMPLETE/ORPHANED

┌─────────────────────────────────────────────────────────────────────────────┐
│ Component                 │ Status        │ Issue                           │
├───────────────────────────┼───────────────┼─────────────────────────────────┤
│ InjectClaudeBrain         │ USED (1x)     │ Only qyl.collector uses it      │
│ ClaudePurpose             │ NEVER DEFINED │ Referenced but never set        │
│ ClaudeLayer               │ NEVER DEFINED │ Referenced but never set        │
│ ClaudeWorkflow            │ NEVER DEFINED │ Referenced but never set        │
│ ClaudeTestCoverage        │ NEVER DEFINED │ Referenced but never set        │
│ ClaudeCriticalFile        │ USED (2x)     │ Only in qyl.collector.csproj    │
│ ClaudeAntiPattern         │ NEVER USED    │ Infrastructure but no consumers │
│ ClaudeRequiredPattern     │ NEVER USED    │ Infrastructure but no consumers │
│ _WriteTextFile UsingTask  │ ORPHANED      │ Only used by _GenerateClaudeMd  │
└─────────────────────────────────────────────────────────────────────────────┘

### Evidence:
- qyl.collector has InjectClaudeBrain=true BUT src/qyl.collector/CLAUDE.md is
  HAND-WRITTEN with detailed content, NOT generated by the target
- The generated format would be a simple markdown table, not the rich YAML
  format currently in the file
- Template references $(ClaudePurpose), $(ClaudeLayer), etc. but no project
  defines these properties

### Recommendation: DELETE THE ENTIRE SYSTEM

The qyl project already maintains rich, hand-written CLAUDE.md files with
detailed YAML content. The auto-generation system:
1. Would produce inferior output (simple tables vs rich YAML)
2. Creates confusion about which CLAUDE.md is authoritative
3. Adds dead code to the build system

Files to delete:
- eng/MSBuild/Shared.targets lines 8-66 (entire CLAUDE.md section)
- qyl.collector.csproj lines 12-19 (InjectClaudeBrain + ClaudeCriticalFile items)

═══════════════════════════════════════════════════════════════════════════════
## 2. LegacySupport.targets - COMPLETELY ORPHANED
═══════════════════════════════════════════════════════════════════════════════

Location: eng/MSBuild/LegacySupport.targets

### What it was supposed to do:
Inject polyfill source files for older .NET frameworks (netstandard2.0,
net472, etc.) to enable features like:
- CallerArgumentExpression (for Throw.IfNull)
- Nullable annotations ([NotNull], [DoesNotReturn])
- init-only property setters (IsExternalInit)

### Status: COMPLETELY ORPHANED

Issues:
1. The file is NEVER IMPORTED anywhere - no <Import Project="...LegacySupport.targets"/>
2. References src/LegacySupport/* folders that DON'T EXIST
3. All conditions check for frameworks < net5.0/net6.0 but project targets net10.0
4. The properties (InjectCallerAttributesOnLegacy etc.) are set in qyl.protocol
   but the targets file isn't imported, so they have no effect

### Evidence:
```
$ grep -r "Import.*LegacySupport" .
# No matches

$ ls src/LegacySupport/
# No such directory
```

### Recommendation: DELETE ENTIRELY

1. Delete eng/MSBuild/LegacySupport.targets
2. Remove from qyl.slnx (line 21)
3. Remove from qyl.protocol.csproj:
   - InjectCallerAttributesOnLegacy
   - InjectDiagnosticAttributesOnLegacy
   - InjectIsExternalInitOnLegacy

These are SDK patterns that don't apply to a single-TFM net10.0 project.

═══════════════════════════════════════════════════════════════════════════════
## 3. Shared.props - UNUSED PROPERTIES
═══════════════════════════════════════════════════════════════════════════════

Location: eng/MSBuild/Shared.props

### Properties defined but never referenced:

┌─────────────────────────────────────────────────────────────────────────────┐
│ Property                  │ Value          │ Usage Count │ Recommendation   │
├───────────────────────────┼────────────────┼─────────────┼──────────────────┤
│ QylOTelSemConvVersion     │ 1.39.0         │ 0           │ DELETE or USE    │
│ QylJsonNamingPolicy       │ SnakeCaseLower │ 0           │ DELETE or USE    │
│ QylOTelEnabled            │ true           │ 1 (self)    │ DELETE (no-op)   │
└─────────────────────────────────────────────────────────────────────────────┘

### What they were supposed to do:
- QylOTelSemConvVersion: Define semconv version for code generation
- QylJsonNamingPolicy: Configure JSON naming convention
- QylOTelEnabled: Enable/disable OTel global usings

### Evidence:
```
$ grep -r '\$(QylOTelSemConvVersion)' .
# No matches

$ grep -r '\$(QylJsonNamingPolicy)' .
# No matches
```

### Recommendation: DECIDE - DELETE OR FINISH

Option A (DELETE): Remove all three properties - they add no value
Option B (FINISH): Use them in SchemaGenerator.cs for code generation

═══════════════════════════════════════════════════════════════════════════════
## 4. TODO Comments in Production Code
═══════════════════════════════════════════════════════════════════════════════

### eng/build/BuildVerify.cs

Line 5:  TODO: Integrate ANcpLua.Roslyn.Utilities.Testing when API is finalized
Line 22: TODO: Use ProjectBuilder for isolated MSBuild execution with binlog
Line 56: TODO: Use ProjectBuilder.Create() for isolated compilation
Line 87: TODO: Execute DDL against in-memory DuckDB for full validation

Recommendation: These are legitimate tracking TODOs for future work.
Keep or convert to GitHub Issues.

### src/qyl.collector/Mcp/McpServer.cs

Line 238: TODO: Implement limit and service_name filters when session query is added

Recommendation: Convert to GitHub Issue or implement.

═══════════════════════════════════════════════════════════════════════════════
## 5. Stray/Temp Files
═══════════════════════════════════════════════════════════════════════════════

.nuke/temp/build-attempt.log
Contents: Hash + target list (likely from failed build attempt)
Recommendation: ADD TO .gitignore if not already, DELETE file

═══════════════════════════════════════════════════════════════════════════════
## SUMMARY - ACTION ITEMS
═══════════════════════════════════════════════════════════════════════════════

### HIGH PRIORITY (Delete - dead code)

1. eng/MSBuild/LegacySupport.targets - ENTIRE FILE
2. eng/MSBuild/Shared.targets lines 8-66 - CLAUDE.md generation section
3. qyl.protocol.csproj - Remove LegacySupport properties (lines 14-16)
4. qyl.collector.csproj - Remove Claude properties (lines 12-19)
5. eng/MSBuild/Shared.props - Remove unused Qyl* properties
6. qyl.slnx line 21 - Remove LegacySupport.targets reference

### MEDIUM PRIORITY (Decide)

7. QylOTelSemConvVersion/QylJsonNamingPolicy - USE in generators or DELETE
8. TODOs in BuildVerify.cs - Convert to Issues or implement

### LOW PRIORITY (Cleanup)

9. .nuke/temp/ - Ensure in .gitignore, delete stray files

═══════════════════════════════════════════════════════════════════════════════
## ROOT CAUSE ANALYSIS
═══════════════════════════════════════════════════════════════════════════════

The orphaned code appears to be remnants of two incomplete initiatives:

1. **SDK Pattern Copy**: Properties like InjectCallerAttributesOnLegacy were
   copied from ANcpLua.NET.Sdk patterns but the infrastructure was never
   completed (missing polyfill files, missing imports).

2. **Auto-Generated CLAUDE.md**: An attempt to generate CLAUDE.md files from
   csproj metadata was started but abandoned when hand-written CLAUDE.md files
   proved more useful. The infrastructure remained but no properties were
   populated.

Both represent "good ideas that didn't pan out" - the scaffolding was built
but never finished. The cleanest solution is removal since the project has
evolved past needing these features.
